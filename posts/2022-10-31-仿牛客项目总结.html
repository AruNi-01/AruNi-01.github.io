<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.48">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" type="image/png" sizes="32x32" href="/img/logo/favicon-32_32.png"><link rel="manifest" href="/manifest.webmanifest"><meta name="application-name" content="AruNi"><meta name="apple-mobile-web-app-title" content="AruNi"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="apple-touch-icon" href="/img/logo/apple-touch-icon.png"><meta name="theme-color" content="#1e2124"><meta name="msapplication-TileColor" content="#1e2124"><title>牛客社区项目总结 | AruNi</title><meta name="description" content="AruNi">
    <link rel="modulepreload" href="/assets/app.75c9db72.js"><link rel="modulepreload" href="/assets/2022-10-31-仿牛客项目总结.html.7fc77f7f.js"><link rel="modulepreload" href="/assets/2022-10-31-仿牛客项目总结.html.81b01d58.js"><link rel="prefetch" href="/assets/index.html.5d70a31e.js"><link rel="prefetch" href="/assets/2022-08-16-Hello_VuePress.html.58bc7bfa.js"><link rel="prefetch" href="/assets/2022-08-21-LeetCode 第 307 场周赛.html.6baebe90.js"><link rel="prefetch" href="/assets/2022-12-1-ThreadLocal 详解.html.8fef6b6a.js"><link rel="prefetch" href="/assets/2022-12-12-什么是 HTTP.html.ed3e4aca.js"><link rel="prefetch" href="/assets/2022-12-16-Java 内存模型.html.a58acf00.js"><link rel="prefetch" href="/assets/404.html.7d858b3d.js"><link rel="prefetch" href="/assets/index.html.de26035a.js"><link rel="prefetch" href="/assets/index.html.4a704eac.js"><link rel="prefetch" href="/assets/index.html.c92bc6f3.js"><link rel="prefetch" href="/assets/index.html.5abce942.js"><link rel="prefetch" href="/assets/index.html.cdfaefff.js"><link rel="prefetch" href="/assets/index.html.bb24b47e.js"><link rel="prefetch" href="/assets/index.html.122e117f.js"><link rel="prefetch" href="/assets/index.html.316d8e9c.js"><link rel="prefetch" href="/assets/index.html.b5449332.js"><link rel="prefetch" href="/assets/index.html.61779abc.js"><link rel="prefetch" href="/assets/index.html.deae5fb3.js"><link rel="prefetch" href="/assets/index.html.d908708c.js"><link rel="prefetch" href="/assets/2022-08-16-Hello_VuePress.html.fb165862.js"><link rel="prefetch" href="/assets/2022-08-21-LeetCode 第 307 场周赛.html.40369a45.js"><link rel="prefetch" href="/assets/2022-12-1-ThreadLocal 详解.html.7c310ba8.js"><link rel="prefetch" href="/assets/2022-12-12-什么是 HTTP.html.15367015.js"><link rel="prefetch" href="/assets/2022-12-16-Java 内存模型.html.9fb72a53.js"><link rel="prefetch" href="/assets/404.html.8244c746.js"><link rel="prefetch" href="/assets/index.html.e10744ae.js"><link rel="prefetch" href="/assets/index.html.f374501e.js"><link rel="prefetch" href="/assets/index.html.84620814.js"><link rel="prefetch" href="/assets/index.html.224bf2e6.js"><link rel="prefetch" href="/assets/index.html.d3d2dc93.js"><link rel="prefetch" href="/assets/index.html.5a43f764.js"><link rel="prefetch" href="/assets/index.html.9ff06914.js"><link rel="prefetch" href="/assets/index.html.a49e0b26.js"><link rel="prefetch" href="/assets/index.html.5b5d2bae.js"><link rel="prefetch" href="/assets/index.html.d69ab11d.js"><link rel="prefetch" href="/assets/index.html.76808e8a.js"><link rel="prefetch" href="/assets/404.3f8e722e.js"><link rel="prefetch" href="/assets/HomePage.7a36c808.js"><link rel="prefetch" href="/assets/Layout.3a833dc7.js"><link rel="prefetch" href="/assets/Links.c7196c8a.js"><link rel="prefetch" href="/assets/Post.4c0cc85a.js"><link rel="prefetch" href="/assets/Tags.329c11ed.js"><link rel="prefetch" href="/assets/index.4f5d4e06.js">
    <link rel="stylesheet" href="/assets/style.f603b422.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container no-sidebar"><!--[--><header class="navbar invert"><span><a href="/" class=""><span class="site-name">$ cd /home/</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="Home"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg></span><span>Home</span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/tags/" class="" aria-label="Tags"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg></span><span>Tags</span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/links/" class="" aria-label="Links"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></span><span>Links</span><!--[--><!--]--></a></div><!--]--><div class="navbar-item"><a style="cursor:pointer;"><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 24 24" fill="currentColor"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 2c4.968 0 9 4.032 9 9s-4.032 9-9 9-9-4.032-9-9 4.032-9 9-9zm0 16c3.867 0 7-3.133 7-7 0-3.868-3.133-7-7-7-3.868 0-7 3.132-7 7 0 3.867 3.132 7 7 7zm8.485.071l2.829 2.828-1.415 1.415-2.828-2.829 1.414-1.414z"/></svg></span><span>Search</span></a></div></nav><!--[--><!--]--><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="Home"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg></span><span>Home</span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/tags/" class="" aria-label="Tags"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg></span><span>Tags</span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/links/" class="" aria-label="Links"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></span><span>Links</span><!--[--><!--]--></a></div><!--]--><div class="navbar-item"><a style="cursor:pointer;"><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 24 24" fill="currentColor"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 2c4.968 0 9 4.032 9 9s-4.032 9-9 9-9-4.032-9-9 4.032-9 9-9zm0 16c3.867 0 7-3.133 7-7 0-3.868-3.133-7-7-7-3.868 0-7 3.132-7 7 0 3.867 3.132 7 7 7zm8.485.071l2.829 2.828-1.415 1.415-2.828-2.829 1.414-1.414z"/></svg></span><span>Search</span></a></div></nav><!--[--><!--]--><!----><!--[--><!--]--></aside><!--]--><div class="page-content"><!--[--><div class="show-catalog post-wrapper"><div class="article-header use-image post-header" style="background-image:url(https://aruni-01-github-io.oss-cn-beijing.aliyuncs.com/posts/nowcoder_project.png);"><div class="article-header-mask" style="background:rgba(40, 57, 101, .4);"></div><div class="article-header-content"><div class="article-tags"><!--[--><span class="article-tag">Project</span><!--]--></div><h1 class="article-title">牛客社区项目总结</h1><p class="article-subtitle">牛客社区项目总结「Tag - Project」</p><div class="article-icons"><div class="article-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-75.52 -43.52 599.04 599.04" fill="currentColor"><path d="M313.6 304c-28.7 0-42.5 16-89.6 16-47.1 0-60.8-16-89.6-16C60.2 304 0 364.2 0 438.4V464c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48v-25.6c0-74.2-60.2-134.4-134.4-134.4zM400 464H48v-25.6c0-47.6 38.8-86.4 86.4-86.4 14.6 0 38.3 16 89.6 16 51.7 0 74.9-16 89.6-16 47.6 0 86.4 38.8 86.4 86.4V464zM224 288c79.5 0 144-64.5 144-144S303.5 0 224 0 80 64.5 80 144s64.5 144 144 144zm0-240c52.9 0 96 43.1 96 96s-43.1 96-96 96-96-43.1-96-96 43.1-96 96-96z"/></svg><span>AruNi_Lu</span></div><div class="article-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-75.52 -43.52 599.04 599.04" fill="currentColor"><path d="M400 64h-48V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H160V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H48C21.5 64 0 85.5 0 112v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48zm-6 400H54c-3.3 0-6-2.7-6-6V160h352v298c0 3.3-2.7 6-6 6z"/></svg><span>2022-10-31</span></div><div class="article-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 24 24" fill="currentColor"><path fill="none" d="M0 0h24v24H0z"/><path d="M17.618 5.968l1.453-1.453 1.414 1.414-1.453 1.453a9 9 0 11-1.414-1.414zM12 20a7 7 0 100-14 7 7 0 000 14zM11 8h2v6h-2V8zM8 1h8v2H8V1z"/></svg><span>55 min</span></div></div></div><!----></div><main class="page post-content"><!--[--><!--]--><div class="theme-gungnir-content"><!--[--><!--]--><div><p>牛客社区项目总结，从数据库设计到重点的功能实现，再到性能优化，另外自己添加了二级缓存</p><div class="custom-container tip"><svg viewBox="0 0 25 25" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><path d="M297.6 258.73H296c-59.47.87-110.69 51.45-111.83 110.43-.626 36.485 16.525 71.085 45.94 92.68 17.86 13.18 29.88 33.56 33.77 56.42h67.62c4-22.82 16.13-43.3 34.16-56.74 28.589-21.097 45.496-54.587 45.496-90.118 0-30.03-12.078-58.833-33.496-79.882a113.133 113.133 0 0 0-80.06-32.79ZM265.19 550.7v26.6c0 4.84 1.17 6.43 1.17 6.43l63.72-.59V550.7h-64.89Z" style="fill:#48b884;fill-rule:nonzero;" transform="matrix(.042 0 0 .042 0 -5.178)"></path><path d="M297.64 123.3C133.26 123.3 0 256.56 0 420.94s133.26 297.63 297.64 297.63 297.63-133.25 297.63-297.63S462 123.3 297.64 123.3ZM385 487.57c-14.11 10.48-22.51 28.09-22.51 47.14v48.43c-.016 17.792-14.648 32.428-32.44 32.45h-64.86c-15.6 0-32.44-12-32.44-38.29v-42.82c0-19-8.21-36.4-21.93-46.52-37.882-27.85-59.959-72.44-59.14-119.45 1.46-77.24 66-141.09 143.81-142.22 38.87.19 76.89 14.37 105 42.11a143.764 143.764 0 0 1 43.14 103c-.159 45.761-21.911 88.86-58.63 116.17Z" style="fill:#48b884;fill-rule:nonzero;" transform="matrix(.042 0 0 .042 0 -5.178)"></path></svg><p class="custom-container-title">本文内容：</p><nav class="table-of-contents"><ul><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_1-数据库设计" class="router-link-active router-link-exact-active">1. 数据库设计</a><ul><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_1-1-用户表-user" class="router-link-active router-link-exact-active">1.1 用户表 user</a></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_1-2-帖子表-discuss-post" class="router-link-active router-link-exact-active">1.2 帖子表 discuss_post</a></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_1-3-评论表-comment" class="router-link-active router-link-exact-active">1.3 评论表 comment</a></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_1-4-消息表-message" class="router-link-active router-link-exact-active">1.4 消息表 message</a></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_1-5-登录凭证表-login-ticket" class="router-link-active router-link-exact-active">1.5 登录凭证表 login_ticket</a></li></ul></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_2-业务开发" class="router-link-active router-link-exact-active">2. 业务开发</a><ul><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_2-1-首页" class="router-link-active router-link-exact-active">2.1 首页</a></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_2-2-注册功能" class="router-link-active router-link-exact-active">2.2 注册功能</a></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_2-3-登录功能-重点" class="router-link-active router-link-exact-active">2.3 登录功能（重点）</a></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_2-4-修改个人信息-重点" class="router-link-active router-link-exact-active">2.4 修改个人信息（重点）</a></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_2-5-过滤敏感词" class="router-link-active router-link-exact-active">2.5 过滤敏感词</a></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_2-6-统一异常处理" class="router-link-active router-link-exact-active">2.6 统一异常处理</a></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_2-7-统一日志管理" class="router-link-active router-link-exact-active">2.7 统一日志管理</a></li></ul></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_3-redis-相关" class="router-link-active router-link-exact-active">3. Redis 相关</a><ul><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_3-1-点赞-重点" class="router-link-active router-link-exact-active">3.1 点赞（重点）</a></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_3-2-关注-重点" class="router-link-active router-link-exact-active">3.2 关注（重点）</a></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_3-3-页面优化" class="router-link-active router-link-exact-active">3.3 页面优化</a></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_3-4-redis-高级数据类型" class="router-link-active router-link-exact-active">3.4 Redis 高级数据类型</a></li></ul></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_4-kafka-相关" class="router-link-active router-link-exact-active">4. Kafka 相关</a><ul><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_4-1-什么是-kafka" class="router-link-active router-link-exact-active">4.1 什么是 Kafka</a></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_4-2-发送系统通知" class="router-link-active router-link-exact-active">4.2 发送系统通知</a></li></ul></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_5-elasticsearch-相关" class="router-link-active router-link-exact-active">5. ElasticSearch 相关</a><ul><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_5-1-为什么要用-es" class="router-link-active router-link-exact-active">5.1 为什么要用 ES</a></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_5-2-什么是-es" class="router-link-active router-link-exact-active">5.2 什么是 ES</a></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_5-3-搜索功能" class="router-link-active router-link-exact-active">5.3 搜索功能</a></li></ul></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_6-定时任务" class="router-link-active router-link-exact-active">6. 定时任务</a><ul><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_6-1-认识-quartz" class="router-link-active router-link-exact-active">6.1 认识 Quartz</a></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_6-2-热榜帖子实现" class="router-link-active router-link-exact-active">6.2 热榜帖子实现</a></li></ul></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_7-二级缓存优化性能" class="router-link-active router-link-exact-active">7. 二级缓存优化性能</a><ul><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_7-1-认识-caffeine" class="router-link-active router-link-exact-active">7.1 认识 Caffeine</a></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_7-2-使用-caffeine" class="router-link-active router-link-exact-active">7.2 使用 Caffeine</a></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_7-3-配合-redis-做二级缓存" class="router-link-active router-link-exact-active">7.3 配合 Redis 做二级缓存</a></li></ul></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_8-项目总结" class="router-link-active router-link-exact-active">8. 项目总结</a></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#_9-心得体会" class="router-link-active router-link-exact-active">9. 心得体会</a></li><li><a aria-current="page" href="/posts/2022-10-31-%E4%BB%BF%E7%89%9B%E5%AE%A2%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93.html#待完善" class="router-link-active router-link-exact-active">待完善</a></li></ul></nav></div><h2 id="_1-数据库设计" tabindex="-1"><a class="header-anchor" href="#_1-数据库设计" aria-hidden="true">#</a> 1. 数据库设计</h2><h3 id="_1-1-用户表-user" tabindex="-1"><a class="header-anchor" href="#_1-1-用户表-user" aria-hidden="true">#</a> 1.1 用户表 user</h3><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210281420343.png" alt="image-20221028141958998"></p><h3 id="_1-2-帖子表-discuss-post" tabindex="-1"><a class="header-anchor" href="#_1-2-帖子表-discuss-post" aria-hidden="true">#</a> 1.2 帖子表 discuss_post</h3><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210281425105.png" alt="image-20221028142548808"></p><blockquote><p>为什么要将帖子评论数量放在帖子表？</p></blockquote><p>如果不放在帖子表，那么在查询帖子的评论数量时就需要先在评论表中查出 post_id 为当前帖子的评论数量，这样在评论表中扫描查询肯定是比直接从帖子表中进行等值查询性能差的。</p><h3 id="_1-3-评论表-comment" tabindex="-1"><a class="header-anchor" href="#_1-3-评论表-comment" aria-hidden="true">#</a> 1.3 评论表 comment</h3><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210281437335.png" alt="image-20221028143740939"></p><h3 id="_1-4-消息表-message" tabindex="-1"><a class="header-anchor" href="#_1-4-消息表-message" aria-hidden="true">#</a> 1.4 消息表 message</h3><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210281446446.png" alt="image-20221028144604816"></p><p>注意：</p><ul><li>消息表既保存用户之间的私信，也保存系统消息通知；</li></ul><p>若保存的是用户之间的私信：</p><ul><li>from_id：发信息的用户 id；</li><li>to_id：收信息的用户 id；</li><li>conversation_id：格式规定为：[参与私信的两个用户 id 中的最小值] _ [参与私信的两个用户 id 中的最大值]。 <ul><li>永远把较小的 id 放在前面的规定保证了私信的唯一性。例如 1_2 和 2_1 是同一个私信。</li></ul></li><li>content：私信的内容，就是普通的 text 文本格式；</li></ul><p>若保存的是系统消息通知：</p><ul><li>from_id：固定为 1，表示系统管理员；</li><li>to_id：要通知的用户 id；</li><li>conversation_id：由于系统通知分为三大类，所以有三种不同的值，每种值对应 Kafka 的 Topic，应为系统通知是采用 Kafka 完成的，具体实现在后面。 <ul><li>follow：关注通知</li><li>like：点赞通知</li><li>comment：评论通知</li></ul></li><li>content：JSON 字符串，具体内容根据通知的类型而定： <ul><li>follow 类型：{&quot;entityType&quot;: 通知类型，3 表示关注，&quot;entityId&quot;：被通知的实体 id(对于关注来说是用户 id)，&quot;userId&quot;: 触发通知的用户 id}</li><li>like 类型：{&quot;entityType&quot;: 通知类型，2 表示点赞，&quot;entityId&quot;: 被通知的实体 id(对于点赞来说是帖子 id)，&quot;postId&quot;: 被点赞的帖子 id，&quot;userId&quot;: 触发点赞的用户 id}</li><li>comment 类型：{&quot;entityType&quot;: 通知类型，1 表示评论，&quot;entityId&quot;：被评论的实体 id(对于评论来说是帖子 id，或者被评论的评论 id)，&quot;postId&quot;: 被评论的帖子 id，&quot;userId&quot;: 触发评论的用户 id}</li></ul></li></ul><h3 id="_1-5-登录凭证表-login-ticket" tabindex="-1"><a class="header-anchor" href="#_1-5-登录凭证表-login-ticket" aria-hidden="true">#</a> 1.5 登录凭证表 login_ticket</h3><p>该表最后被废弃，使用 Redis 代替了。</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210281622257.png" alt="image-20221028162221130"></p><p>凭证相当与 session，只是用了数据库表来存这个凭证信息。</p><p>在登录时将用户的信息存入 login_ticket 表中，在请求前从数据库中获取凭证，若获取成功且凭证有效说明用户已登录。</p><h2 id="_2-业务开发" tabindex="-1"><a class="header-anchor" href="#_2-业务开发" aria-hidden="true">#</a> 2. 业务开发</h2><h3 id="_2-1-首页" tabindex="-1"><a class="header-anchor" href="#_2-1-首页" aria-hidden="true">#</a> 2.1 首页</h3><p>首页需要的数据有帖子信息（标题，时间等）、帖子作者信息（用户的头像、用户名）。</p><p>所以只需要查询出所有的帖子，得到帖子后，再根据 user_id 查出用户信息，将它们一对一的封装到一个 Map 类型的 List 中，返回给前端即可。</p><p>为了减小数据库和浏览器的压力，需要分页返回数据。</p><blockquote><p>分页功能的设计</p></blockquote><p>自定义了一个分页的类，表示分页时所需的信息：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Page</span> <span class="token punctuation">{</span>

    <span class="token comment">// 当前页码，默认1</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> current <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">// 每页显示的数量，默认10</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> limit <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token comment">//数据总数，用于计算总页面数量</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> rows<span class="token punctuation">;</span>

    <span class="token comment">// 查询路径，某页的 url（用于复用分页的连接）</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> path<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 获取当前页的起始行
     * <span class="token keyword">@return</span> 当前页的起始行
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// current * limit - limit</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>current <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> limit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 获取总页数
     * <span class="token keyword">@return</span> 总页数
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// rows / limit [+1]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rows <span class="token operator">%</span> limit <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> rows <span class="token operator">/</span> limit<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">return</span> rows<span class="token operator">/</span> limit <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 获取起始页码（页数较多时，只显示当前页号的前两个页号和两个页号）
     * <span class="token keyword">@return</span> 起始页码
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> from <span class="token operator">=</span> current <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> from <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> from<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * 获取最后页码（页数较多时，只显示当前页号的前两个页号和两个页号）
     * <span class="token keyword">@return</span> 最后页码
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> <span class="token keyword">to</span> <span class="token operator">=</span> current <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> total <span class="token operator">=</span> <span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">to</span> <span class="token operator">&gt;</span> total <span class="token operator">?</span> total <span class="token operator">:</span> <span class="token keyword">to</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCurrent</span><span class="token punctuation">(</span><span class="token keyword">int</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> current<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLimit</span><span class="token punctuation">(</span><span class="token keyword">int</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>limit <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> limit <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>limit <span class="token operator">=</span> limit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRows</span><span class="token punctuation">(</span><span class="token keyword">int</span> rows<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rows <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>rows <span class="token operator">=</span> rows<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>分页对象信息在前后端互传：</p><ul><li><p>初始时后端会根据 Page 对象的默认 <code>current</code> 和 <code>limit</code> 查询出对应条数的数据传给前端；</p></li><li><p>前端可以根据 Page 对象获取页的总数、当前页的起始位置等信息，当点击别的页时，会将 Page 对象的 <code>current</code> 改成对应的页号，然后通过 <code>path</code> 重新访问后端，将新的 Page 传给后端，后端再获取新 Page 中的页号，重新查询数据返回；</p></li></ul><h3 id="_2-2-注册功能" tabindex="-1"><a class="header-anchor" href="#_2-2-注册功能" aria-hidden="true">#</a> 2.2 注册功能</h3><p>注册功能不需要返回什么数据，若注册成功则跳转到成功页面，给一个激活账号的连接，注册失败则需要将原因提示给用户。</p><p>若能注册成功：</p><ol><li>需要随机为用户生成一个盐，用于对密码加密，数据库中存储的都是加密后的密码。</li><li>随机生成一个激活码，发送激活邮件，直接使用 SpringMail。</li></ol><h3 id="_2-3-登录功能-重点" tabindex="-1"><a class="header-anchor" href="#_2-3-登录功能-重点" aria-hidden="true">#</a> 2.3 登录功能（重点）</h3><p>因为登录成功后，需要将登录信息保存起来，方便用户进行以后的请求，所以需要考虑下面的问题。</p><p>分布式 session 问题：</p><p>传统的做法是直接查询 user 表获取 user 对象，然后存入 session 中，之后就可以根据 session 获取用户信息了。</p><p>这样的方案在分布式部署时会出现什么问题呢？</p><p>分布式部署意味着有多台服务器，而 session 是存储在服务器上的，那么如果我下次请求的服务器和我初始时请求的服务器不一样，就会因另一台服务器没有保存我的 session 而判定我为未登录状态。</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210281719174.png" alt="image-20221028171918119"></p><p>如何解决呢？</p><ul><li>可以同步服务器的 session，但是这样不久浪费服务器资源了吗？</li><li>那要不，使用 cookie？cookie 以明文形式存储在客户端，不安全。</li></ul><p>我们初步的解决方案是建一个登录凭证表，把用户信息保存到表中，有一个 ticket 字段，存放到 cookie 中，因为只是存放了一串随机字符串到 cookie，其他隐私信息都在表中，需要通过 ticket 访问表才能获取。</p><p>但是这样岂不是要额外建一张表来存放凭证信息，也有点浪费资源啊，而且每次都要查询数据库，效率也不高。</p><p>所以最终的解决方案是使用 <strong>Redis</strong>：</p><ul><li>存储的 key 为 ticket，value 为字符串即可，因为要将登录凭证 LoginTicket 对象序列化后再存入 Redis；</li><li>同样，还是把 ticket 存放到 cookie 中；</li><li>由于 Redis 的性能高，而且设置了凭证的过期时间，过期的键会自动从 Redis 中删除，也不浪费资源；</li></ul><p>现在在登录成功后，会生成一个带有用户信息和过期时间的登录凭证 LoginTicket 对象，保存到 Redis 中。</p><p>接着还要把生成的凭证 ticket 存入到客户端的 cookie 中，同样也要设置相同的过期时间。</p><p>之后客户端向服务器请求的时候就会带上 cookie。</p><p>那么我们从哪儿获取 cookie 呢？当然时要在用户请求页面前获取，这样才能在页面显示前把用户的状态查询出来。</p><p>我们通过 <strong>拦截器</strong> 来实现，使用 Spring 自带的拦截器，实现 HandlerInterceptor 后，可以重写 3 个方法：</p><ul><li>preHandle：在目标请求方法执行前执行；</li><li>postHandle：在目标请求方法执行之后，视图未返回前执行；</li><li>afterCompletion：在整个流程执行完毕后执行（DispatcherServlet 完全处理完请求后）；</li></ul><p>最后在 WebMvcConfig（需实现 WebMvcConfigurer）的 addInterceptors 方法中添加该拦截器，即可实现拦截功能。</p><p>根据我们的业务需求，我们需要在请求前查询出用户的登录状态。</p><p>所以需要在 preHandle 中获取凭证信息，通过请求 request 获取到 cookie 后，再根据 cookie 从 Redis 汇总查询出 LoginTicket 对象，登录凭证中即有用户的 id，那么就能获取到用户的所有信息了。</p><p>那我们获取到用户信息后，为了后面的操作中可以方便的获取用户信息，怎么样保存这个用户信息呢？</p><p>一个好的方法是使用 <strong>ThreadLocal</strong>，<strong>它可以在同一线程中很方便的获取用户信息，不需要频繁的传递对象</strong>。</p><p>所以在 preHandle 中获取到用户信息后，将用户信息存入 ThreadLocal，后续在任何地方都可以从 ThreadLocal 中获取到当前用户的信息。</p><p>除此之外，当用户存入 ThreadLocal 后，我们还在 postHandle 中通过 ThreadLocal 获取用户传给前端，方便前端判断当前用户是否已具有登录凭证。</p><p>最后，当整个流程执行完毕后，记得在 afterCompletion 中清理掉 ThreadLocal，否则可能发生内存泄漏（GC 自动清理没有清理掉）。</p><p>拦截器代码如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@desc</span>: 登录凭证拦截器，用于在请求前获取凭证
 * 若获取成功且凭证有效说明用户已登录，将用户存入 ThreadLocal 中，
 * 然后在生成视图之前将 ThreadLocal 中的当前用户传给视图层，
 * 视图层根据 loginUser 是否为空来判断用户是否已登录。
 * <span class="token keyword">@author</span>: AruNi_Lu
 * <span class="token keyword">@date</span>: 2022/10/11
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginTicketInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">LoginTicketInterceptor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从 Cookie 中获取凭证</span>
        <span class="token class-name">String</span> ticket <span class="token operator">=</span> <span class="token class-name">CookieUtil</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">&quot;ticket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 查询凭证</span>
            <span class="token class-name">LoginTicket</span> loginTicket <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findLoginTicket</span><span class="token punctuation">(</span>ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 检查凭证是否有效</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>loginTicket <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> loginTicket<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> loginTicket<span class="token punctuation">.</span><span class="token function">getExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 根据凭证查询用户</span>
                <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>loginTicket<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 在本次请求中持有用户（存入ThreadLocal，在controller中通过UserThreadLocal.get直接获取即可）</span>
                <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 构建用户认证的结果，并存入 SecurityContext，以便于 Security 进行授权</span>
                <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>
                        user<span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userService<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SecurityContextImpl</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">ModelAndView</span> modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从 ThreadLocal 中获取该用户，返回给视图层</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> modelAndView <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">&quot;loginUser&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 在 DispatcherServlet 完全处理完请求后被调用</span>
        <span class="token comment">// 视图层都用完了，清理掉 ThreadLocal，否则可能有内存泄露的风险（GC 自动清理没有清理掉）</span>
        <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//        SecurityContextHolder.clearContext();</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-修改个人信息-重点" tabindex="-1"><a class="header-anchor" href="#_2-4-修改个人信息-重点" aria-hidden="true">#</a> 2.4 修改个人信息（重点）</h3><p>修改个人信息不是主要的，重点是需要登录的用户才能进行修改页面的访问。</p><p>可以使用上面的拦截器来实现，但是如果以后又有一些页面要登录后才能访问，那加一个需求就去修改拦截器源码吗？如果我又不想拦截了呢，又去把对应的源码删掉？这样也太麻烦了。</p><p>所以这里提供另一种拦截方式，通过 <strong>自定义注解</strong> 进行拦截。被这个注解标注的请求方法，就会被这个拦截器拦截。</p><p>自定义一个 LoginRequired 注解，里面什么也不用写，只是其一个标注的作用：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">LoginRequired</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后编写拦截器，拦截带有此注解的方法：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@desc</span>: 需要登录才能请求的拦截器
 * 使用注解实现：
 *      当方法中注解了 @LoginRequired 时，说明该方法需要登录后才能请求
 *      本拦截器就是根据注解来拦截对应的方法的
 * <span class="token keyword">@author</span>: AruNi_Lu
 * <span class="token keyword">@date</span>: 2022/10/12
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginRequiredInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 当前拦截的对象是一个方法时，才拦截</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token keyword">instanceof</span> <span class="token class-name">HandlerMethod</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取当前拦截的方法</span>
            <span class="token class-name">Method</span> method <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HandlerMethod</span><span class="token punctuation">)</span> handler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">LoginRequired</span> loginRequired <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">LoginRequired</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 若当前拦截的方法注解了 @LoginRequired，说明当前方法需要登录，</span>
            <span class="token comment">// 但 ThreadLocal 取不到用户，说明未登录，需要拦截。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>loginRequired <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 重定向到登录界面，不放行</span>
                response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getContextPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后也要在 WebMvcConfig 中添加此拦截器。</p><p>现在，只需要在需要进行登录拦截的请求方法中加上此注解，就会被该拦截器拦截了。</p><h3 id="_2-5-过滤敏感词" tabindex="-1"><a class="header-anchor" href="#_2-5-过滤敏感词" aria-hidden="true">#</a> 2.5 过滤敏感词</h3><p>过滤敏感词主要是为了发帖时和评论时对敏感词进行过滤，过滤敏感词使用前缀树比较方便，可以依次比较某个区间的内容是否为敏感内容。</p><blockquote><p>什么是前缀树？</p></blockquote><p>Trie 树也称为前缀树、字典树，最大的特点就是 <strong>共享字符串的公共前缀</strong> 来达到节省空间的目的。</p><p>Trie 树的根节点不存储数据，每一条完整的分支代表一个完整的字符串。</p><p><strong>Trie 树的本质，就是利用字符串之间的公共前缀，将重复的前缀合并在一起</strong>。</p><p>举例：</p><p>有 6 个字符串，它们分别是：how，hi，her，hello，so，see。我们希望在里面多次查找某个字符串是否存在。如果每次查找，都是拿要查找的字符串跟这 6 个字符串依次进行字符串匹配，那效率就比较低，有没有更高效的方法呢？</p><p>这个时候，我们就可以先对这 6 个字符串做一下预处理，组织成 Trie 树的结构，之后每次查找，都是在 Trie 树中进行匹配查找。最后构造出来的就是下面这个图中的样子：</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210291316198.png" alt="image-20221029131606877"></p><p>所以利用前缀树的特点，可以很方便的进行敏感词过滤的设计。</p><blockquote><p>敏感词过滤设计</p></blockquote><p>在设计敏感词过滤的过程中，我们可以这样定义Trie树：</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210291318306.png" alt="image-20221029131855347"></p><p>图中的红叉表示标记到这个字符，从 <code>root </code>到此字符所经过的字符串是敏感词。</p><p>把所有敏感词存入Trie树中，设置三个指针：p1、p2、p3。</p><p>其中：p1 指向 Trie 树的根节点，p2 和 p3 指向待过滤的字符数组。</p><p>过滤过程算法如下：</p><ol><li>p1 找到 root 下一层，看有没有与 p2 指向相同的字符，若没有则说明以 p2 位置开始的字符不是敏感词，p2 和 p3 都向后移动；若有则说明 p2 位置开始的字符可能是敏感词，p2 固定不动，p3 向后移动，然后重复上述过程；</li><li>如果 p1 指向了带标记的节点，那么说明 p2 ~ p3 区间的字符是敏感词，将 p2 ~ p3 区间的字符串用 *** 代替并存入结果数组中，此时将 p2 和 p3 都移动到 p3 + 1 的位置，开始下一轮的过滤；</li><li>如果 p1 没有指向带标记的节点，说明 p2 ~ p3 区间的字符不是敏感词，则将 p2++，p3 = p2，重新开始下一轮的过滤；</li><li>当 p3 == 数组长度时，将剩余字符加入结果数组；</li></ol><p>复杂度分析：</p><ul><li>如果敏感词的长度为 m，则每个敏感词的查找时间复杂度是 O(m)，字符串的长度为 n，我们需要遍历 n 遍，所以敏感词 <strong>查找</strong> 这个过程的时间复杂度是 <strong>O(n * m)</strong>。</li><li>如果有 t 个敏感词的话，<strong>构建</strong> trie 树的时间复杂度是 <strong>O(t * m)</strong>。</li></ul><blockquote><p>代码实现</p></blockquote><p>从上图可以看到，每个节点都保存了当前节点的字符值和它的子节点，所以可以使用 Map 来表示每个节点，key 为字符，value 为子节点；因为一个节点的子节点个数未知，采用 HashMap 还可以动态拓展，而且可以在 O(1) 复杂度内判断某个子节点是否存在。</p><p>所以，前缀树的结构定义如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// 前缀树结构的定义</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">TrieNode</span> <span class="token punctuation">{</span>

        <span class="token comment">// 关键词结束标识（以关键词结尾的字符的此属性为 true）</span>
        <span class="token keyword">private</span> <span class="token keyword">boolean</span> isKeyWordEnd  <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token comment">// 子节点集合（key：下级字符，value：下级节点）</span>
        <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">TrieNode</span><span class="token punctuation">&gt;</span></span> subNodesMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setKeyWordEnd</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> keyWordEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            isKeyWordEnd <span class="token operator">=</span> keyWordEnd<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 添加子节点</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addSubNode</span><span class="token punctuation">(</span><span class="token class-name">Character</span> c<span class="token punctuation">,</span> <span class="token class-name">TrieNode</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            subNodesMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 获取子节点</span>
        <span class="token keyword">public</span> <span class="token class-name">TrieNode</span> <span class="token function">getSubNode</span><span class="token punctuation">(</span><span class="token class-name">Character</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> subNodesMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>我们需要提前初始化好前缀树，以便进行敏感词的匹配过滤，所以需要先写一个添加敏感词到前缀树的方法：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// 把一个敏感词添加到前缀树中</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addKeyword</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 定义一个变量指向根节点，从根开始添加</span>
        <span class="token class-name">TrieNode</span> curNode <span class="token operator">=</span> rootNode<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keyword<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">char</span> c <span class="token operator">=</span> keyword<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TrieNode</span> subNode <span class="token operator">=</span> curNode<span class="token punctuation">.</span><span class="token function">getSubNode</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果当前字符还没有子节点，说明前缀树中没有该字符，需要初始化，</span>
            <span class="token comment">// 否则沿着子节点继续添加下一个字符</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>subNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 初始化子节点，接到当前节点上</span>
                subNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrieNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                curNode<span class="token punctuation">.</span><span class="token function">addSubNode</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> subNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 指向子节点，进入下一轮循环</span>
            curNode <span class="token operator">=</span> subNode<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 设置结束标识</span>
        curNode<span class="token punctuation">.</span><span class="token function">setKeyWordEnd</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在项目启动的时候，需要根据敏感词文件中的敏感词来初始化前缀树，利用 Spring 的 @PostConstruct 注解，在 Bean 被实例化，调用构造器之后，就初始化前缀树：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// 在 bean 被实例化，调用构造器之后，@PostConstruct 标注的方法就会被自动调用</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token comment">// 初始化前缀树</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span>
                <span class="token comment">// 从类加载器中获取加载好的资源（敏感词文件），然后将字符流转为缓冲流读取该文件</span>
                <span class="token class-name">InputStream</span> is <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">&quot;sensitive-words.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">BufferedReader</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> keyword<span class="token punctuation">;</span>
            <span class="token comment">// 一行一行的读取</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>keyword <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 添加到前缀树</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addKeyword</span><span class="token punctuation">(</span>keyword<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接下来就只剩下过滤的核心方法了，这个方法需要在业务中使用，具体实现如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 过滤敏感词（供外界调用）
     * <span class="token keyword">@param</span> <span class="token parameter">text</span> 待过滤的文本
     * <span class="token keyword">@return</span> 过滤后的文本
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 指针1：用于遍历前缀树</span>
        <span class="token class-name">TrieNode</span> curNode <span class="token operator">=</span> rootNode<span class="token punctuation">;</span>
        <span class="token comment">// 指针2：遍历文本的左边界</span>
        <span class="token keyword">int</span> begin <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// 指针3：遍历文本的右边界（指针2，3 形成的区间的文本可能是敏感词）</span>
        <span class="token keyword">int</span> pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">// 过滤算法：遍历文本的过程中，同时遍历整颗前缀树，找出符合的文本</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>pos <span class="token operator">&lt;</span> text<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">char</span> c <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 跳过符号（“聪明”的网友：跟我来%赌$博%）</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSymbol</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 若指针1 处于根节点，将此符号计入结果，让指针2 向下走</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>curNode <span class="token operator">==</span> rootNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    begin<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 无论符号在开头还是中间，指针3 都向下走</span>
                pos<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 检查下级节点</span>
            curNode <span class="token operator">=</span> curNode<span class="token punctuation">.</span><span class="token function">getSubNode</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 下级节点为空，表示以 begin 开头的字符不是敏感词</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>curNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>begin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 进入下一个位置</span>
                pos <span class="token operator">=</span> <span class="token operator">++</span>begin<span class="token punctuation">;</span>
                <span class="token comment">// 重新指向根节点，开始下一个字符的判断</span>
                curNode <span class="token operator">=</span> rootNode<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>isKeyWordEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 发现敏感词，替换</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>REPLACEMENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 进入下一个位置</span>
                begin <span class="token operator">=</span> <span class="token operator">++</span>pos<span class="token punctuation">;</span>
                <span class="token comment">// 重新指向根节点</span>
                curNode <span class="token operator">=</span> rootNode<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 检查下一个字符</span>
                pos<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 由于循环是以指针3 pos（右区间）为结束条件，所以最后可能还有区间没被加入进结果中</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>begin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 判断是否为符号</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isSymbol</span><span class="token punctuation">(</span><span class="token class-name">Character</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// isAsciiAlphanumeric() 判断是否为数字或希腊字母 | 0x2E80-0x9FFF 之间的字符是东亚文字</span>
        <span class="token keyword">return</span> <span class="token operator">!</span><span class="token class-name">CharUtils</span><span class="token punctuation">.</span><span class="token function">isAsciiAlphanumeric</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;</span> <span class="token number">0x2E80</span> <span class="token operator">||</span> c <span class="token operator">&gt;</span> <span class="token number">0x9FFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-6-统一异常处理" tabindex="-1"><a class="header-anchor" href="#_2-6-统一异常处理" aria-hidden="true">#</a> 2.6 统一异常处理</h3><p>SpringBoot 对于异常的处理也做了不错的支持，它提供了 2 个注解：</p><ul><li><strong>@ControllerAdvice</strong>：用来 <strong>开启全局的异常捕获</strong>，说明要在哪些地方捕获；</li><li><strong>@ExceptionHandler</strong>：说明 <strong>捕获哪些异常</strong>，对那些异常进行处理；</li></ul><p>统一异常处理利用了 AOP 的思想，在没有改变原有代码的情况下实现了异常处理。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@desc</span>: @ControllerAdvice作用：给 Controller 控制器添加统一的操作或处理。
 * 对加了 @Controller 注解的控制器添加统一的异常处理（AOP实现）
 * <span class="token keyword">@author</span>: AruNi_Lu
 * <span class="token keyword">@date</span>: 2022/10/15
 */</span>
<span class="token annotation punctuation">@ControllerAdvice</span><span class="token punctuation">(</span>annotations <span class="token operator">=</span> <span class="token class-name">Controller</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AllExceptionHandler</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">AllExceptionHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 进行异常处理，处理 Exception.class 的异常(全部异常)</span>
    <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handlerException</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;服务器发生异常：&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StackTraceElement</span> element <span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">String</span> xRequestWith <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;x-requested-with&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 判断是异步还是普通请求，异步请求需要返回 JSON 字符串，普通请求返回错误页面</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;XMLHttpRequest&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>xRequestWith<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;application/plain;charset=utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">PrintWriter</span> writer <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;服务器异常！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getContextPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-7-统一日志管理" tabindex="-1"><a class="header-anchor" href="#_2-7-统一日志管理" aria-hidden="true">#</a> 2.7 统一日志管理</h3><p>Spring 对统一日志管理做了集合，使用的是 logback，只需要在 resource 下创建 <code>logback-spring.xml</code> 配置文件配置日志的记录格式，日志类型等等，就可以直接在项目中使用。</p><p>而我们现在自己定义一个日志，来记录每个用户在什么时间点访问了业务层的什么方法。</p><p>Spring 提供了比较方便的方式，不用动原本的业务层代码，也是使用 AOP 思想，将切点定义为需要记录日志的地方即可实现。</p><p>首先来了解一下 AOP 的几个核心概念：</p><ul><li>通知（Advice）：就是 <strong>自己想要的功能</strong>，比如我们这里要打印日志。</li><li>连接点（JoinPoint）：就是 <strong>使用通知的地方</strong>，Spring 只支持方法连接点，方法执行前/后、return 之后、抛出异常之后都是连接点。</li><li>切点（Pointcut）：有时候我们不希望在所有的方法上都使用 Advice，而 Pointcut 就是提供一组规则来匹配 JoinPoint，给满足规则的 JoinPoint 使用 Advice。</li><li>切面（Aspect）：通知和切点的结合。其实连接点就是为了方便理解切点而定义出来的。通知说明了干什么和什么时候干（什么时候干在定义通知的时候可以指定），而切入点说明了在哪干（指定到底是哪个方法），这就是一个完整的切面定义。</li><li>织入（Weaving）：把切面应用到目标对象来创建新的代理对象的过程，Spring 中用的是运行时。</li></ul><p>通知有以下几种类型：</p><ul><li>@Before(&quot;pointcur()&quot;)：在执行切点之前需要做的通知；</li><li>@After(&quot;pointcur()&quot;)：在执行切点之后需要做的通知；</li><li>@AfterReturning(&quot;pointcur()&quot;)：在返回值之后需要做的通知；</li><li>@AfterThrowing(&quot;pointcur()&quot;)：在抛出异常后需要做的通知；</li><li>@Around(&quot;pointcur()&quot;)：环绕通知，可在切点前后做通知，</li></ul><p>定义方法时参数可以传入 JoinPoint，用来执行被通知的方法（<code>joinPoint.process()</code>）或者获取被执行的方法（<code>joinPoint.getSignature().getName()</code>）。</p><p>根据我们的业务需求，在 service 层方法执行前，记录下访问记录即可，所以切点定义的规则定义为 <code>service.Impl</code> 包下的所有方法都要使用通知。具体的通知内容在执行切点之前做，所以使用 @Before。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@desc</span>: 利用 AOP，记录用户访问业务方法的日志
 * <span class="token keyword">@author</span>: AruNi_Lu
 * <span class="token keyword">@date</span>: 2022/10/15
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Aspect</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceLogAspect</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">ServiceLogAspect</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 切点，让 service.impl 包下的所有方法执行通知，execution 格式：返回值 包下的方法(参数)</span>
    <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">&quot;execution(* com.run.nowcoder.service.impl.*.*(..))&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 在执行切点之前需要做的通知</span>
    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">&quot;pointcut()&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 用户[ip]，在[now_time]，访问了[com.run.nowcoder.service.impl.xxx()]</span>
        <span class="token comment">// 利用 RequestContextHolder 工具的 getRequestAttributes() 方法获取请求上下文</span>
        <span class="token class-name">ServletRequestAttributes</span> attributes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据请求上下文获取 request</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>attributes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据 request 获取 ip 地址</span>
        <span class="token class-name">String</span> ip <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRemoteHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取方法类型名 + 方法名</span>
        <span class="token class-name">String</span> target <span class="token operator">=</span> joinPoint<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaringTypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> joinPoint<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;用户[%s]，在[%s]，访问了[%s]&quot;</span><span class="token punctuation">,</span> ip<span class="token punctuation">,</span> now<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-redis-相关" tabindex="-1"><a class="header-anchor" href="#_3-redis-相关" aria-hidden="true">#</a> 3. Redis 相关</h2><h3 id="_3-1-点赞-重点" tabindex="-1"><a class="header-anchor" href="#_3-1-点赞-重点" aria-hidden="true">#</a> 3.1 点赞（重点）</h3><p>点赞业务本身并不复杂，无非是对数据的 update，但是点赞本身是无意识行为，并且同一个用户可对博文进行点赞/取消点赞，如果直接操作数据库，无疑会增加数据库 io 操作。</p><p>所以这里使用 Redis 来存储点赞数据。</p><p>对于数据类型的选用：</p><ul><li>由于我们需要快速判断该用户是否对帖子/评论点过赞，所以需要判断某个元素是否在集合中，因此使用 Set，它提供了一个 <code>SISMEMBER</code> 命令来判断元素是否在集合中；</li></ul><p>对于 key 的设计：</p><ul><li>我们现在有对帖子的点赞和对评论的点赞，或许后面还会开放对其他实体的点赞。所以我们要设置一个实体类型 entityType，来区分点赞的类型；</li><li>然后在实体类型后面跟上该实体的 id 即可（postId / commentId）；</li><li>所以点赞功能的 key 为 like:entity:entityType:entityId；</li><li>value 为给该实体点赞的用户 id</li></ul><p>由于我们还要统计每个用户获得的总赞数，所以在记录点赞时也要顺便把用户的总赞数 +1。</p><p>每个用户的总赞数用 String 数据类型来储存，key 为 like:user:userId，value 为获得的赞总数。</p><p>因为点赞和统计用户赞的总数是一组不可分割的行为，所以需要保证原子性，因此使用事务来执行这两条命令。</p><p>至于这个点赞操作的实体类型，以及实体 id 和 被点赞人的 id，都是从前端传过来，而对于点赞者可以通过 ThreadLocal 来获取。</p><h3 id="_3-2-关注-重点" tabindex="-1"><a class="header-anchor" href="#_3-2-关注-重点" aria-hidden="true">#</a> 3.2 关注（重点）</h3><p>关注和点赞非常类似，关注操作需要更新关注者的关注信息，还要更新被关注者的关注信息，所以也需要在事务中操作。</p><p>对于关注操作，我们使用 zSet 来存储：</p><ul><li>因为在显示关注列表和粉丝列表时，一般都是按照时间降序显示的；</li><li>而且方便后续添加共同关注的功能，zSet 也支持取交集；</li></ul><p>某个用户关注的实体，key 的设计：</p><ul><li>除了关注用户外，以后还有可能关注某个频道、关注某个标签等等功能，所以我们这里不能把 key 设计死，也需要根据类型来设计；</li><li>所以 key 为某个用户所关注的实体：<code>followee:useId:entityType</code>；value 为这个实体所对应的 id，和关注的时间：<code>zSet(entityId, nowTime)</code>；</li></ul><p>某个实体所拥有的粉丝，key 的设计：</p><ul><li><p>同上面类似，key 为某个实体（实体类型和实体 id 唯一确定一个实体），value 为该实体的粉丝集合（粉丝其实就是用户）；</p></li><li><p>所以，key：<code>follower:entityType:entityId</code>；value：<code>zSet(userId, nowTime)</code>；</p></li></ul><h3 id="_3-3-页面优化" tabindex="-1"><a class="header-anchor" href="#_3-3-页面优化" aria-hidden="true">#</a> 3.3 页面优化</h3><p>我们有一些访问数据库的操作是非常频繁的，例如在进入首页的时候就要查询一整页的帖子信息，帖子确实可以一次性查出一页的数据来，但是每个帖子对应的作者则需要查询多次，有多少个帖子就要查询多少次，这样频繁的访问数据库效率是比较低的，所以我们考虑用 Redis 来做缓存。</p><p>查询用户时，根据下面三步走：</p><ol><li>当查询时，优先从缓存中取值；</li><li>取不到时再走数据库，将查出的数据存入缓存中再返回；</li><li>数据更新时要及时清除缓存。注意，这里不是采用更新缓存，而是直接清除。因为若更新数据库频繁，而缓存的数据不一定会频繁使用，所以删除比更新开销小。</li></ol><p>缓存代码如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/*
    优化：使用 Redis 缓存登录的用户，这样在页面间访问时，可以直接从缓存中取，而不用每次都访问数据库，
    缓存只保留一小时，用户下次请求时若缓存没有命中，则冲数据库中查出数据，放入缓存再返回。
     */</span>
    <span class="token comment">// 1.当查询时，优先从缓存中取值</span>
    <span class="token keyword">private</span> <span class="token class-name">User</span> <span class="token function">getCache</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> userKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2.取不到时初始化缓存数据</span>
    <span class="token keyword">private</span> <span class="token class-name">User</span> <span class="token function">initCache</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 先从数据库中查询，存入缓存后再返回</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> userKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>userKey<span class="token punctuation">,</span> user<span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3.数据更变时清除缓存（不更新缓存是因为若更新数据库频繁，而缓存的数据不一定会频繁使用，所以删除比更新开销小）</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clearCache</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> userKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>userKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在需要查询用户的地方优先使用缓存即可：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">findUserById</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//        return userMapper.selectById(id);</span>

        <span class="token comment">// 优化：先从缓存中查询用户，查不到则初始化缓存</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token function">getCache</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> user <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> user <span class="token operator">:</span> <span class="token function">initCache</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在更新用户信息的地方记得都要调用清除缓存的方法。</p><h3 id="_3-4-redis-高级数据类型" tabindex="-1"><a class="header-anchor" href="#_3-4-redis-高级数据类型" aria-hidden="true">#</a> 3.4 Redis 高级数据类型</h3><p>下面介绍两种 Redis 高级数据类型，用于统计网站的 UV(Unique Visitor) 和 DAU(Daily Active User)。</p><blockquote><p>HyperLogLog</p></blockquote><p>HyperLogLog 是用来做基数统计的，所谓基数统计，就是指一串数字中不重复的数字个数，如 {1，2，1，2，3} 的基数集就是 {1，2，3}，基数就是3。</p><p>基本操作：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 添加数据</span>
pfadd key element <span class="token punctuation">[</span>element <span class="token punctuation">..</span>.<span class="token punctuation">]</span> 

<span class="token comment"># 统计数据</span>
pfcount key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span>

<span class="token comment"># 合并数据</span>
pfmerge destkey sourcekey <span class="token punctuation">[</span>sourcekey<span class="token punctuation">..</span>.<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>HyperLogLog 特点：</p><ul><li><p>用于进行基数统计，不是集合，不保存数据，只记录数量而不是具体数据</p></li><li><p>核心是基数估算算法，最终数值存在一定误差</p></li><li><p>误差范围：基数估计的结果是一个带有 0.81% 标准错误的近似值</p></li><li><p>耗空间极小，每个 hyperloglog key 占用了 12K 的内存用于标记基数</p></li><li><p>pfadd 命令不是一次性分配 12K 内存使用，会随着基数的增加内存逐渐增大</p></li><li><p>Pfmerge命令合并后占用的存储空间为 12K，无论合并之前数据量多少</p></li></ul><p>业务场景：</p><ul><li>统计页面实时 UV 数、统计在线用户数、统计用户每天搜索不同词条的个数。</li><li>而 BitMaps（下面说）则用于判断某个用户是否访问过页面。</li></ul><blockquote><p>BitMaps</p></blockquote><p>介绍：</p><ul><li>BitMaps 就是通过一个 bit 位来表示某个元素对应的值或者状态，其中的 key 就是对应元素本身；</li><li>可以把 Bitmaps 想象成是一串二进制数字，每个位置只存储 0 或 1（某种状态），下标是 Bitmaps 的偏移量（offset）；</li><li>因为一个字节有 8 位，所以 BitMaps 本身会极大的节省存储空间；</li></ul><p>基本操作：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 获取指定 key 对应偏移量上的 bit 值</span>
getbit key offset       <span class="token comment"># 如果没有设置的话，默认是 0</span>

<span class="token comment"># 设置指定 key 对应偏移量上的 bit 值，value 只能是 0 或 1</span>
setbit key offset value      <span class="token comment"># 偏移量很大的话，也能设置，但是前面要补 0，比较耗时</span>
 
<span class="token comment"># 对指定 key 按位进行交、并、非、异或操作，并将结果保存到 destKey 中</span>
bitop <span class="token function">op</span> destKey key1 <span class="token punctuation">[</span>key2<span class="token punctuation">..</span>.<span class="token punctuation">]</span>         <span class="token comment"># op：and（交）、or（并）、not（非）、xor（异或）</span>
  
<span class="token comment"># 统计指定 key 中 1 的数量</span>
bitcount key <span class="token punctuation">[</span>start end<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>业务场景：</p><ul><li>统计用户在指定范围内登录过多少次；</li><li>统计指定日期范围内的 DAU 数量；</li><li>统计每天网站的 PV（Page Visitor），不能统计 UV，因为 UV 要去重；</li></ul><blockquote><p>UV 和 DAU 的实现</p></blockquote><p>使用 Redis，首先都要设计好 key，由于我们的需求是既可以对单日进行统计，也可以对某个区间范围进行统计，所以需要设计两种类型的 key。</p><p>对于 UV，采用 HyperLogLog：</p><ul><li>单日 UV 的 key 为 uv:date，value 为当天访问过网站的 ip 地址集合；</li><li>区间 UV 的 key 为 uv:startDate:endDate，value 为 ip 地址集合；（区间 UV 其实就是把范围日期内的单日 UV 进行合并，再存入区间 UV 中）</li></ul><p>对于 DUA，采用 BitMap：</p><ul><li>单日 DUA的 key 为 dua:date，offset 为 userId，value 为 0|1；</li><li>区间 DUA的 key 为 dua:startDate:endDate，offset 为在指定日期范围内，活跃用户的 userId，value 为 0|1；（区间 DUA 其实就是把范围日期内的单日 DUA 进行 OR 运算，再存入区间 DUA 中）</li></ul><p>注：单日 UV 和 DUA 只是用于在用户访问的时候记录进 Redis，我们的业务主要是范围统计。而范围统计要靠每一天的 UV 和 DUA 合并计算出来的。</p><p>key 设计好了，那么我们什么时候进行统计呢？在哪儿统计呢？</p><p>肯定要在请求时进行统计，那么可以用拦截器实现，在用户访问页面时，必然先走拦截器：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DataService</span> dataService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 统计 UV</span>
        <span class="token class-name">String</span> ip <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRemoteHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataService<span class="token punctuation">.</span><span class="token function">recordUV</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 统计 DAU</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dataService<span class="token punctuation">.</span><span class="token function">recordDAU</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>主要的统计业务，范围统计：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 统计指定日期范围内的 UV 数量
     * <span class="token keyword">@param</span> <span class="token parameter">start</span> 开始时间
     * <span class="token keyword">@param</span> <span class="token parameter">end</span> 结束时间
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">calculateUV</span><span class="token punctuation">(</span><span class="token class-name">Date</span> start<span class="token punctuation">,</span> <span class="token class-name">Date</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> end <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;参数不能为空！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 整理该日期范围内的 key</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keyList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Calendar 工具可用于处理跟时间相关的逻辑</span>
        <span class="token class-name">Calendar</span> calendar <span class="token operator">=</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        calendar<span class="token punctuation">.</span><span class="token function">setTime</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 当得到的时间不在结束时间之后时，统计每一天的key，且将时间 +1天，继续下一次循环统计</span>
        <span class="token comment">// 不用 .before(end) 是因为会漏掉 end 时间</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>calendar<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getUVKey</span><span class="token punctuation">(</span>sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>calendar<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            calendar<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span>DATE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 合并这些数据，存入 范围UV 的 key 中</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getUVKey</span><span class="token punctuation">(</span>sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">,</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHyperLogLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">union</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> keyList<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 返回统计结果</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHyperLogLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token doc-comment comment">/**
     * 统计指定日期范围内的 DAU 数量
     * <span class="token keyword">@param</span> <span class="token parameter">start</span> 开始时间
     * <span class="token keyword">@param</span> <span class="token parameter">end</span> 结束时间
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">calculateDAU</span><span class="token punctuation">(</span><span class="token class-name">Date</span> start<span class="token punctuation">,</span> <span class="token class-name">Date</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> end <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;参数不能为空！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 整理该日期范围内的 key，BitMap存储的key类型是字节数组</span>
        <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> keyList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Calendar 工具可用于处理跟时间相关的逻辑</span>
        <span class="token class-name">Calendar</span> calendar <span class="token operator">=</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        calendar<span class="token punctuation">.</span><span class="token function">setTime</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 当得到的时间不在结束时间之后时，统计每一天的key，且将时间 +1天，继续下一次循环统计</span>
        <span class="token comment">// 不用 .before(end) 是因为会漏掉 end 时间</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>calendar<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getDAUKey</span><span class="token punctuation">(</span>sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>calendar<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            calendar<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span>DATE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 进行 OR 运算，日期范围内任意一天登录过都算活跃，存入范围DAU 的 key 中</span>
        <span class="token class-name">Object</span> dauCnt <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RedisCallback</span><span class="token punctuation">)</span> connection <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getDAUKey</span><span class="token punctuation">(</span>sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">,</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            connection<span class="token punctuation">.</span><span class="token function">bitOp</span><span class="token punctuation">(</span><span class="token class-name">RedisStringCommands<span class="token punctuation">.</span>BitOperation</span><span class="token punctuation">.</span>OR<span class="token punctuation">,</span>
                    redisKey<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> keyList<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 返回 key 为 范围DAU 中位为1的数量</span>
            <span class="token keyword">return</span> connection<span class="token punctuation">.</span><span class="token function">bitCount</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> dauCnt<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Controller 层接收前端传入的时间，查询到统计结果后响应即可：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DataService</span> dataService<span class="token punctuation">;</span>

    <span class="token comment">// 跳转到统计页面，支持 POST 请求是为了让下面的 /data/uv 能转发过来</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">&quot;/data&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">,</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDataPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;/site/admin/data&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 统计网站 UV，@DateTimeFormat 将前端传来的字符串类型的日期转为我们指定的格式</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">&quot;/data/uv&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUV</span><span class="token punctuation">(</span><span class="token annotation punctuation">@DateTimeFormat</span><span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Date</span> start<span class="token punctuation">,</span>
                        <span class="token annotation punctuation">@DateTimeFormat</span><span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Date</span> end<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> uv <span class="token operator">=</span> dataService<span class="token punctuation">.</span><span class="token function">calculateUV</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;uvResult&quot;</span><span class="token punctuation">,</span> uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;uvStartDate&quot;</span><span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;uvEndDate&quot;</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* 此处可以用转发：转发到 /data 页面，此页面的信息会被带到转发的页面，转发是在一个请求中完成的，
        要求转发的请求与原请求类型相同，这也是为什么上面写 /data 请求时要支持 POST；*/</span>
        <span class="token comment">// 不能用重定向：因为重定向相当于客户端重新单独发了一次 /data 请求，此页面的信息不会携带过去；</span>
        <span class="token keyword">return</span> <span class="token string">&quot;forward:/data&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 统计网站 DAU</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">&quot;/data/dau&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDAU</span><span class="token punctuation">(</span><span class="token annotation punctuation">@DateTimeFormat</span><span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Date</span> start<span class="token punctuation">,</span>
                        <span class="token annotation punctuation">@DateTimeFormat</span><span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Date</span> end<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> uv <span class="token operator">=</span> dataService<span class="token punctuation">.</span><span class="token function">calculateDAU</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;dauResult&quot;</span><span class="token punctuation">,</span> uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;dauStartDate&quot;</span><span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;dauEndDate&quot;</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;forward:/data&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-kafka-相关" tabindex="-1"><a class="header-anchor" href="#_4-kafka-相关" aria-hidden="true">#</a> 4. Kafka 相关</h2><h3 id="_4-1-什么是-kafka" tabindex="-1"><a class="header-anchor" href="#_4-1-什么是-kafka" aria-hidden="true">#</a> 4.1 什么是 Kafka</h3><p>Kafka 的核心概念：</p><ul><li>生产者（Producer）与消费者（Consumer）： <ul><li>生产者（也称为发布者）创建消息；</li><li>而消费者（也称为订阅者）负责消费 or 读取消息；</li></ul></li><li>主题（Topic）与分区（Partition）： <ul><li>在 Kafka 中消息以主题来分类，每一个主题都对应一个「消息队列」。</li><li>一个 Topic 被分成多个 Partition，Partition 是最小的 <strong>存储单元</strong>，掌握着一个 Topic 的部分数据。</li></ul></li><li>Broker 和集群（Cluster）： <ul><li>一个 Kafka 服务器也称为 Broker，它接受生产者发送的消息并存入磁盘。</li><li>Broker 同时服务消费者拉取分区消息的请求，返回目前已经提交的消息。</li><li>一个 Broker 每秒可以处理成千上万的分区和百万量级的消息。</li><li>若干个 Broker 组成一个集群（Cluster），其中集群内某个 Broker 会成为集群控制器（Cluster Controller），它负责管理集群。</li></ul></li></ul><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210301628001.webp" alt="img"></p><p>Kafka特点：</p><ul><li>高吞吐量、消息持久化、高可靠性、高扩展性。</li></ul><h3 id="_4-2-发送系统通知" tabindex="-1"><a class="header-anchor" href="#_4-2-发送系统通知" aria-hidden="true">#</a> 4.2 发送系统通知</h3><p>其实系统通知和发普通私信是一样的，只是消息的发送者是系统而已。</p><p>那么为什么系统通知要使用 Kafka 呢？</p><ul><li>系统通知是触发点赞，关注，评论等功能时，通知被动方。可能在某一时间点一个热贴的点赞或评论很多，这时如果每次都讲通知保存在数据库，那并发量太大了，系统性能明显会下降。</li><li>所以利用消息队列，当触发点赞，关注，评论等功能时，就把相应的通知丢到消息队列中，让系统异步的去消费消息（发通知）。</li></ul><blockquote><p>规定 Topic 和 content</p></blockquote><p>很明显，每类通知都要对应一种 Topic：</p><ul><li>评论 Topic：comment</li><li>点赞 Topic：like</li><li>关注 Topic：follow</li></ul><p>Topic 对应的 content 定义为一个 JSON 字符串，我们将其封装成一个 Event 实体对象便于 JSON 的转化：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Event</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> topic<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> userId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> entityType<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> entityId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> entityUserId<span class="token punctuation">;</span>
    <span class="token comment">// 其他数据信息</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>因为系统通知也是消息的一种，所以我们将系统通知也存入 message 表中，message 表如下：</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210281446446.png" alt="image-20221028144604816"></p><p>在系统消息中，各字段的含义如下：</p><ul><li>from_id：固定为 1，表示系统管理员；</li><li>to_id：要通知的用户 id；</li><li>conversation_id：由于系统通知分为三大类，所以有三种不同的值，<strong>每种值对应 Kafka 的 Topic</strong>： <ul><li>follow：关注通知</li><li>like：点赞通知</li><li>comment：评论通知</li></ul></li><li>content：JSON 字符串，具体内容根据通知的类型而定： <ul><li>follow 类型：{&quot;entityType&quot;: 通知类型，3 表示关注，&quot;entityId&quot;：被通知的实体 id(对于关注来说是用户 id)，&quot;userId&quot;: 触发通知的用户 id}</li><li>like 类型：{&quot;entityType&quot;: 通知类型，2 表示点赞，&quot;entityId&quot;: 被通知的实体 id(对于点赞来说是帖子 id)，&quot;postId&quot;: 被点赞的帖子 id，&quot;userId&quot;: 触发点赞的用户 id}</li><li>comment 类型：{&quot;entityType&quot;: 通知类型，1 表示评论，&quot;entityId&quot;：被评论的实体 id(对于评论来说是帖子 id，或者被评论的评论 id)，&quot;postId&quot;: 被评论的帖子 id，&quot;userId&quot;: 触发评论的用户 id}</li></ul></li></ul><blockquote><p>Kafka 的使用</p></blockquote><p>想要使用 Kafka，首先得先定义一个事件的生产者，用在我们需要发送通知的地方，把事件丢给生产者就行了。然后再为 Topic 定义一个消费者，监听生产者的队列，有事件就进行消费即可。</p><p>生产者的定义如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EventProducer</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">KafkaTemplate</span> kafkaTemplate<span class="token punctuation">;</span>

    <span class="token comment">// 处理事件（发消息）</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">fireEvent</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 将事件发布到指定的主题，内容是事件对象的 JSON 字符串</span>
        kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着，在需要发送通知的地方封装事件，丢给生产者。例如在添加评论时，把评论事件丢给生产者：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">&quot;/add/{discussPostId}&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">addComment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;discussPostId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> discussPostId<span class="token punctuation">,</span> <span class="token class-name">Comment</span> comment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        comment<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        comment<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        comment<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        commentService<span class="token punctuation">.</span><span class="token function">addComment</span><span class="token punctuation">(</span>comment<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 触发评论事件（通知给被评论的用户），EntityType，EntityId 等信息前端已经赋上了</span>
        <span class="token class-name">Event</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token class-name">CommonConstant</span><span class="token punctuation">.</span>TOPIC_COMMENT<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setEntityType</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setEntityId</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getEntityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">&quot;postId&quot;</span><span class="token punctuation">,</span> discussPostId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 由于不知道评论的目标是子评论还是帖子，所以需要判断</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">CommonConstant</span><span class="token punctuation">.</span>ENTITY_TYPE_POST<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">DiscussPost</span> target <span class="token operator">=</span> discussPostService<span class="token punctuation">.</span><span class="token function">findDiscussPostById</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getEntityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            event<span class="token punctuation">.</span><span class="token function">setEntityUserId</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">CommonConstant</span><span class="token punctuation">.</span>ENTITY_TYPE_COMMENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Comment</span> target <span class="token operator">=</span> commentService<span class="token punctuation">.</span><span class="token function">findCommentById</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getEntityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            event<span class="token punctuation">.</span><span class="token function">setEntityUserId</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        eventProducer<span class="token punctuation">.</span><span class="token function">fireEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:/discuss/detail/&quot;</span> <span class="token operator">+</span> discussPostId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在消息事件已经被生产者接收，放入队列中了，接下来就要定义消费者去消费这个 Topic 中的事件了。由于评论、点赞、关注都是属于系统通知，所以可以用一个消费者消费这三类 Topic：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * 消费 评论/点赞/关注 事件
     * <span class="token keyword">@param</span> <span class="token parameter">record</span>
     */</span>
    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">CommonConstant</span><span class="token punctuation">.</span>TOPIC_COMMENT<span class="token punctuation">,</span> <span class="token class-name">CommonConstant</span><span class="token punctuation">.</span>TOPIC_LIKE<span class="token punctuation">,</span> <span class="token class-name">CommonConstant</span><span class="token punctuation">.</span>TOPIC_FOLLOW<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handlePDGMessage</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>record <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;消息的内容为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 从队列中获取消息</span>
        <span class="token class-name">Event</span> event <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Event</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;消息格式错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 发送站内通知</span>
        <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        message<span class="token punctuation">.</span><span class="token function">setFromId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 系统通知的id为1</span>
        message<span class="token punctuation">.</span><span class="token function">setToId</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getEntityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 通知目标实体的id</span>
        message<span class="token punctuation">.</span><span class="token function">setConversationId</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        message<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// message 中的内容（content），JSON 字符串类型</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> content <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        content<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        content<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;entityType&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        content<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;entityId&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getEntityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 其他数据消息，通过 event.getData()（Map） 来获取</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>event<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            content<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        message<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        messageService<span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从代码中可以看到，消费者消费消息的步骤为：</p><ol><li>从对应 Topic 的队列中获取消息事件；</li><li>将事件的内容读取出来，插入到 message 表中；</li><li>用户在访问页面时，就会访问 MessageController 中的获取通知的请求方法，将系统通知和私信都读出来，最后显示在页面上，就完成了通知功能。</li></ol><p>除了系统通知，Kafka 还用于更新 ES（帖子的增删改后都要更新 ES） ，或者一些对实时性要求没有那么高的功能。</p><h2 id="_5-elasticsearch-相关" tabindex="-1"><a class="header-anchor" href="#_5-elasticsearch-相关" aria-hidden="true">#</a> 5. ElasticSearch 相关</h2><h3 id="_5-1-为什么要用-es" tabindex="-1"><a class="header-anchor" href="#_5-1-为什么要用-es" aria-hidden="true">#</a> 5.1 为什么要用 ES</h3><p>我们使用 ES 最多的就是搜索功能了，数据库也能做搜索功能啊，比如：</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>discuss_post<span class="token punctuation">`</span></span> <span class="token keyword">where</span> content <span class="token operator">like</span> <span class="token string">&#39;%寒冬%&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这样也能把 &quot;寒冬&quot; 相关的内容的帖子搜索出来，但是像 content like &#39;%寒冬%&#39; 这类查询是不走索引的。</p><p>从 SQL 执行的分析结果中可以看出，上面的查询语句没有可用的索引，且查询类型为 ALL（全表扫描）：</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210301822836.png" alt="image-20221030182241344"></p><p>你可能会说，那好办，那我在 content 列添加一个索引呗。但是 content 列的类型为 text，我们需要给出前缀索引长度才能为此列建立索引，因为索引列的长度是有限制的。那如果我要查询的关键字就是在 content 中的后面部分呢？你只建立前缀索引有什么用？所以建立 content 索引列不是很方便。</p><p>还有一个解决办法，MySQL 5.6 版本开始，InnoDB 也支持全文索引（全文索引有自己的语法格式），5.7.6 之后也有了中文的全文分析器 ngram。所以我们可以在 content 列建立全文索引。</p><p>但是 MySQL 的全文索引有些性能问题：</p><ul><li>当搜索的结果集较大时，会引发执行异常，需要调高相关内存参数配置；</li><li>输入目标文本越长，性能越低；</li><li>符合条件记录数越多，性能越低；</li></ul><p>而且，我们有时候也不需要将符合条件的结果全部返回给用户，可能用户就查看前面一两页的数据，所以要求前面的数据一定要是相关性最强的。</p><p>所以，专业的事（全文搜索）还是交给专业的人（ES）来做吧！</p><h3 id="_5-2-什么是-es" tabindex="-1"><a class="header-anchor" href="#_5-2-什么是-es" aria-hidden="true">#</a> 5.2 什么是 ES</h3><blockquote><p>ES 能干什么</p></blockquote><p>我们主要讨论它的核心功能 — 搜索：</p><ul><li>Elasticsearch 对模糊搜索非常擅长（搜索速度很快）</li><li>从Elasticsearch 搜索到的数据可以根据 <strong>评分</strong> 过滤掉大部分的，只要返回评分高的给用户就好了（原生就支持排序）</li><li>没有那么准确的关键字也能搜出相关的结果（能匹配有相关性的记录）</li></ul><blockquote><p>ES 的核心概念</p></blockquote><p>节点（Node）、集群（Cluster）、分片（Shards）：</p><ul><li>节点（Node）：单个实例称为一个节点；</li><li>集群（Cluster）：一组节点构成一个集群；</li><li>分片（Shards）：分片是底层的工作单元，文档保存在分片内，分片又被分配到集群内的各个节点里，每个分片仅保存全部数据的一部分。</li></ul><p>索引 Index、类型 Type 和文档 Document，对比我们比较熟悉的 MySQL 数据库：</p><ul><li>index → db</li><li><s>type → table</s></li><li>document → row</li></ul><p><strong>注意</strong>：在 ES 7.0 之后的版本中 Type 被废弃了。一个 index 中只有一个默认的 type，即 _doc。</p><p>ES 的 Type 被废弃后，库表合一，Index 既可以被认为对应 MySQL 的 Database，也可以认为对应 table。</p><p>所以 ES 7.0 之后可以这样认为：</p><ul><li>ES 实例：对应 MySQL 实例中的一个 Database。</li><li>Index 对应 MySQL 中的 Table 。</li><li>Document 对应 MySQL 中表的记录</li></ul><h3 id="_5-3-搜索功能" tabindex="-1"><a class="header-anchor" href="#_5-3-搜索功能" aria-hidden="true">#</a> 5.3 搜索功能</h3><p>接下来，我们就利用 ES 来实现搜索功能。</p><blockquote><p>ES 客户端配置</p></blockquote><p>首先要建立一个 ES 客户端，用于连接 ES，然后在这个客户端上进行复杂的查询操作：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EsConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${spring.elasticsearch.uris}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> esUrl<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">RestHighLevelClient</span> <span class="token function">esClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ClientConfiguration</span> clientConfiguration <span class="token operator">=</span> <span class="token class-name">ClientConfiguration</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">connectedTo</span><span class="token punctuation">(</span>esUrl<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">RestClients</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>clientConfiguration<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在需要使用的地方用 <code>@Qualifier(&quot;esClient&quot;)</code> 指定类名注入即可。</p><p>还要将数据存入到 ES 中，可以使用 ElasticsearchRepository 接口，只要继承它就可以使用了：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">DiscussPostRepository</span> <span class="token keyword">extends</span> <span class="token class-name">ElasticsearchRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>除此之外，为了方便，我们创建一个 SearchResult 实体类，用于存放查询结果：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@desc</span>: 用于暂存 es 中查询到的列表和总行数
 * <span class="token keyword">@author</span>: AruNi_Lu
 * <span class="token keyword">@date</span>: 2022/10/20
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchResult</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">long</span> total<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SearchResult</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">,</span> <span class="token keyword">long</span> total<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>list <span class="token operator">=</span> list<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>total <span class="token operator">=</span> total<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>功能实现</p></blockquote><p>在 service 层提供数据存入 ES，从 ES 删除数据，查询数据的方法：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ElasticsearchServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ElasticsearchService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DiscussPostRepository</span> postRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;esClient&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">RestHighLevelClient</span> restHighLevelClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveDiscussPost</span><span class="token punctuation">(</span><span class="token class-name">DiscussPost</span> discussPost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        postRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>discussPost<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteDiscussPost</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        postRepository<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">SearchResult</span> <span class="token function">searchDiscussPost</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyword<span class="token punctuation">,</span> <span class="token keyword">int</span> current<span class="token punctuation">,</span> <span class="token keyword">int</span> limit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">&quot;discusspost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//discusspost是索引名，就是表名</span>
        <span class="token comment">//高亮</span>
        <span class="token class-name">HighlightBuilder</span> highlightBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HighlightBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        highlightBuilder<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        highlightBuilder<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        highlightBuilder<span class="token punctuation">.</span><span class="token function">requireFieldMatch</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        highlightBuilder<span class="token punctuation">.</span><span class="token function">preTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;span style=&#39;color:red&#39;&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        highlightBuilder<span class="token punctuation">.</span><span class="token function">postTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/span&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//构建搜索条件</span>
        <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">multiMatchQuery</span><span class="token punctuation">(</span>keyword<span class="token punctuation">,</span> <span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">SortBuilders</span><span class="token punctuation">.</span><span class="token function">fieldSort</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder</span><span class="token punctuation">.</span>DESC<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">SortBuilders</span><span class="token punctuation">.</span><span class="token function">fieldSort</span><span class="token punctuation">(</span><span class="token string">&quot;score&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder</span><span class="token punctuation">.</span>DESC<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">SortBuilders</span><span class="token punctuation">.</span><span class="token function">fieldSort</span><span class="token punctuation">(</span><span class="token string">&quot;createTime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder</span><span class="token punctuation">.</span>DESC<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span>  <span class="token comment">// 指定从哪条开始查询</span>
                <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span>    <span class="token comment">// 需要查出的总记录条数</span>
                <span class="token punctuation">.</span><span class="token function">highlighter</span><span class="token punctuation">(</span>highlightBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//高亮</span>

        searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> total <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">DiscussPost</span> discussPost <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DiscussPost</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 处理高亮显示的结果</span>
            <span class="token class-name">HighlightField</span> titleField <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>titleField <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                discussPost<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>titleField<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">HighlightField</span> contentField <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>contentField <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                discussPost<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>contentField<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token comment">//                System.out.println(discussPost);</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>discussPost<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SearchResult</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> total<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其中，save 和 delete 在添加帖子和删除帖子时调用，具体的调用方式是：</p><ol><li>在添加帖子和删除帖子时，先将事件丢入 Kafka，而不是立即更新 ES；</li><li>然后再在消费者中调用 save 和 delete 方法进行具体的删除。</li></ol><p>search 方法是核心，其主要完成了：</p><ul><li>关键词的高亮；</li><li>根据关键词对 titile 和 content 进行匹配；</li></ul><p>Controller 层只需要提供一个请求方法即可：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ElasticsearchService</span> elasticsearchService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LikeService</span> likeService<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 通过 ES 搜索帖子
     * <span class="token keyword">@param</span> <span class="token parameter">keyword</span> 搜索关键词
     * <span class="token keyword">@param</span> <span class="token parameter">page</span> 分页信息
     * <span class="token keyword">@param</span> <span class="token parameter">model</span>
     * <span class="token keyword">@return</span>
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span>
     */</span>
    <span class="token comment">// search?keyword=xxx</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">&quot;/search&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyword<span class="token punctuation">,</span> <span class="token class-name">Page</span> page<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 搜索帖子</span>
        <span class="token class-name">SearchResult</span> result <span class="token operator">=</span> elasticsearchService<span class="token punctuation">.</span><span class="token function">searchDiscussPost</span><span class="token punctuation">(</span>keyword<span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 聚合数据</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> discussPosts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DiscussPost</span> post <span class="token operator">:</span> result<span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">,</span> post<span class="token punctuation">)</span><span class="token punctuation">;</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>post<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;likeCount&quot;</span><span class="token punctuation">,</span> likeService<span class="token punctuation">.</span><span class="token function">findEntityLikeCount</span><span class="token punctuation">(</span><span class="token class-name">CommonConstant</span><span class="token punctuation">.</span>ENTITY_TYPE_POST<span class="token punctuation">,</span> post<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                discussPosts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;discussPosts&quot;</span><span class="token punctuation">,</span> discussPosts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span> keyword<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 分页信息</span>
        page<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token string">&quot;/search?keyword=&quot;</span> <span class="token operator">+</span> keyword<span class="token punctuation">)</span><span class="token punctuation">;</span>
        page<span class="token punctuation">.</span><span class="token function">setRows</span><span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token string">&quot;/site/search&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-定时任务" tabindex="-1"><a class="header-anchor" href="#_6-定时任务" aria-hidden="true">#</a> 6. 定时任务</h2><p>因为热榜帖子是每隔一段时间更新一次的，所以很适合用定时任务来完成这个业务。</p><h3 id="_6-1-认识-quartz" tabindex="-1"><a class="header-anchor" href="#_6-1-认识-quartz" aria-hidden="true">#</a> 6.1 认识 Quartz</h3><p>使用 JDK 的 ScheduledExecutorService 和 Spring 的 ThreadPoolTaskScheduler 都可以实现定时任务，但是没有 Quartz 功能强大。</p><p>Quartz 可以根据 Cron 表达式自由的自定义定时任务的规则，比如每月每天什么时候执行任务。</p><p>Quartz 的核心概念：</p><ul><li>Job：即需要完成的工作，需要实现 org.quartz.job 接口，重写 execute 方法，定时器到时后就会执行。</li><li>Trigger：执行任务的触发器，比如你想每天定时 1 点发送邮件，Trigger 将会设置 1 点执行该任务。</li><li>Scheduler：任务的调度器，会将 Job 和 Trigger 结合，负责基于 Trigger 设定的时间执行 Job</li></ul><h3 id="_6-2-热榜帖子实现" tabindex="-1"><a class="header-anchor" href="#_6-2-热榜帖子实现" aria-hidden="true">#</a> 6.2 热榜帖子实现</h3><p>在首页的热帖排行榜中，帖子是根据热度排行的，热度用分数来衡量。</p><p>我们每次在对帖子进行添加、评论、加精、点赞时，都会对帖子的分数造成影响，所以在这些地方都需要更新帖子分数。</p><p>帖子分数肯定不是实时更新的，我们将需要更新的帖子 id 存入 Redis 中，然后用定时任务去 Redis 中取帖子来更新。因为不管我们对帖子做了多少次更改，最后对每一个帖子都只计算一次分数，为了避免重复对一个帖子进行更新，所以 key 使用 set 类型。</p><p>分析好业务功能后，开始定义我们的 Job：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@desc</span>: 定时任务，定时刷新帖子的分数
 * <span class="token keyword">@author</span>: AruNi_Lu
 * <span class="token keyword">@date</span>: 2022/10/23
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PostScoreRefreshJob</span> <span class="token keyword">implements</span> <span class="token class-name">Job</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">PostScoreRefreshJob</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DiscussPostService</span> discussPostService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LikeService</span> likeService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ElasticsearchService</span> elasticsearchService<span class="token punctuation">;</span>

    <span class="token comment">// 牛客纪元，计算分数时需要</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Date</span> NOWCODER_EPOCH<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            NOWCODER_EPOCH <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">&quot;2014-08-01 00:00:00&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ParseException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;初始化牛客纪元失败！&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">JobExecutionContext</span> jobExecutionContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JobExecutionException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getPostScoreKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取绑定 redisKey 的对象，后面直接通过这个对象来进行有关与 redisKey 相关的操作</span>
        <span class="token class-name">BoundSetOperations</span> operations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundSetOps</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>operations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[任务取消] 没有需要刷新分数的帖子&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[任务开始] 正在刷新帖子分数：&quot;</span> <span class="token operator">+</span> operations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 当 set 中有要刷新的帖子时，依次弹出进行刷新</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>operations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> operations<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[任务结束] 帖子分数刷新完毕！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token keyword">int</span> postId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DiscussPost</span> post <span class="token operator">=</span> discussPostService<span class="token punctuation">.</span><span class="token function">findDiscussPostById</span><span class="token punctuation">(</span>postId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>post <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;该帖子不存在：id = &quot;</span> <span class="token operator">+</span> postId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 是否加精</span>
        <span class="token keyword">boolean</span> wonderful <span class="token operator">=</span> post<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">// 评论数量</span>
        <span class="token keyword">int</span> commentCount <span class="token operator">=</span> post<span class="token punctuation">.</span><span class="token function">getCommentCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 点赞数量</span>
        <span class="token keyword">long</span> likeCount <span class="token operator">=</span> likeService<span class="token punctuation">.</span><span class="token function">findEntityLikeCount</span><span class="token punctuation">(</span><span class="token class-name">CommonConstant</span><span class="token punctuation">.</span>ENTITY_TYPE_POST<span class="token punctuation">,</span> postId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 计算权重</span>
        <span class="token keyword">double</span> w <span class="token operator">=</span> <span class="token punctuation">(</span>wonderful <span class="token operator">?</span> <span class="token number">75</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> commentCount <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">+</span> likeCount <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token comment">// 分数 = 帖子权重 + 距离天数</span>
        <span class="token keyword">double</span> score <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">log10</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">+</span> <span class="token punctuation">(</span>post<span class="token punctuation">.</span><span class="token function">getCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> NOWCODER_EPOCH<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">3600</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 更新帖子分数</span>
        discussPostService<span class="token punctuation">.</span><span class="token function">updateScore</span><span class="token punctuation">(</span>postId<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 同步 ES 数据</span>
        post<span class="token punctuation">.</span><span class="token function">setScore</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span><span class="token punctuation">;</span>
        elasticsearchService<span class="token punctuation">.</span><span class="token function">saveDiscussPost</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>接着去配置 Trigger 即可：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@desc</span>: Quartz 配置类：配置 -&gt; 数据库 -&gt; 调用
 *      1. 项目启动，该配置被加载，下面的配置会被插入到数据库
 *      2. 接着就可以根据数据库中的配置数据进行调度
 * <span class="token keyword">@author</span>: AruNi_Lu
 * <span class="token keyword">@date</span>: 2022/10/22
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QuartzConfig</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
    FactoryBean 可简化 Bean 的实例化过程：
        1. 通过 FactoryBean 封装 Bean 的实例化过程
        2. 将 FactoryBean 装配到 Spring 容器
        3. 将 FactoryBean 注入给其他的 Bean
        4. 该 Bean 得到的是 FactoryBean 所管理的对象实例
     */</span>

    <span class="token comment">// 刷新帖子分数任务</span>
    <span class="token comment">// 配置 JobDetail，装配到 Spring 容器</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">JobDetailFactoryBean</span> <span class="token class-name">PostScoreRefreshJobDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">JobDetailFactoryBean</span> factoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobDetailFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setJobClass</span><span class="token punctuation">(</span><span class="token class-name">PostScoreRefreshJob</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;postScoreRefreshJob&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token string">&quot;nowcoderGroup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setDurability</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setRequestsRecovery</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> factoryBean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 配置 Trigger，将名为 PostScoreRefreshJobDetail 的 Bean 通过 Bean 名字注入进来，直接使用</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">SimpleTriggerFactoryBean</span> <span class="token class-name">PostScoreRefreshTrigger</span><span class="token punctuation">(</span><span class="token class-name">JobDetail</span> <span class="token class-name">PostScoreRefreshJobDetail</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SimpleTriggerFactoryBean</span> factoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleTriggerFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setJobDetail</span><span class="token punctuation">(</span><span class="token class-name">PostScoreRefreshJobDetail</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;postScoreRefreshTrigger&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token string">&quot;nowcoderGroup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setRepeatInterval</span><span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 5min 执行一次</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setJobDataMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JobDataMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> factoryBean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后在对帖子进行添加、评论、加精、点赞时，将对应的 postId 存入 Redis 即可，当 Redis 中该 key 对应的 set 集合不为空时，定时任务会自动从 Redis 中取出帖子来更新。</p><h2 id="_7-二级缓存优化性能" tabindex="-1"><a class="header-anchor" href="#_7-二级缓存优化性能" aria-hidden="true">#</a> 7. 二级缓存优化性能</h2><p>我们的热榜帖子是使用定时任务更新的，所以更新不会很频繁，而且热榜帖子通常是访问最频繁的。</p><p>因此，热榜帖子非常适合再加一个 <strong>本地缓存</strong>。将数据缓存在应用服务器上，性能最好。</p><p>因为 Redis 需要网络开销，增加时耗。本地缓存是直接从本地内存中读取，没有网络开销，比较适合数据量较小的缓存。我们只缓存 15 - 20 个热点帖子到本地，因为一般用户只看前两三页。</p><p>我们规定了热榜帖子的 orderMode 为 1，所以我们只对 oderMode 为 1，userId 为 0（userId 为 0 表示查询所有帖子，不为 0 表示查询某个 user 的帖子）的查询帖子列表加本地缓存。</p><p>除了对帖子列表的查询做本地缓存外，还有查询帖子的总页数也要做，因为加载热榜帖子页面时，也要加载总页数，不能让加载总页数的查询拖了后腿。</p><h3 id="_7-1-认识-caffeine" tabindex="-1"><a class="header-anchor" href="#_7-1-认识-caffeine" aria-hidden="true">#</a> 7.1 认识 Caffeine</h3><p>本地缓存常用的工具有 Ehcache、Guava、Caffeine 等，我们使用 Caffeine，它是目前性能最好的缓存工具。</p><blockquote><p>Caffeine 配置说明</p></blockquote><p>如下图：</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210311545410.webp" alt="img"></p><p>注意：</p><ul><li>weakValues 和 softValues 不可以同时使用。</li><li>maximumSize 和 maximumWeight 不可以同时使用。</li><li>expireAfterWrite 和 expireAfterAccess 同事存在时，以 expireAfterWrite 为准。</li></ul><h3 id="_7-2-使用-caffeine" tabindex="-1"><a class="header-anchor" href="#_7-2-使用-caffeine" aria-hidden="true">#</a> 7.2 使用 Caffeine</h3><p>首先，肯定是在原始的业务层去添加本地缓存，所以定位到 <code>DiscussPostServiceImpl</code>。</p><p>Caffeine 的核心接口是 Cache，子接口有 LoadingCache（同步加载），AsyncLoadingCache（异步加载）。</p><p>Caffeine 内部通过 ConcurrentHashMap 实现，所以使用加载和获取缓存都是通过哈希表的 key-value 方式。</p><p>在 DiscussPostServiceImpl 业务层定义缓存，且初始化好：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@desc</span>: 帖子相关业务类，使用 Caffeine 本地缓存 热点帖子（定期更新能保证变更不频繁，而访问很频繁）
 * <span class="token keyword">@author</span>: AruNi_Lu
 * <span class="token keyword">@date</span>: 2022/10/8
 */</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DiscussPostServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">DiscussPostService</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">DiscussPostService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DiscussPostMapper</span> discussPostMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SensitiveFilter</span> sensitiveFilter<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${caffeine.posts.max-size}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxSize<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${caffeine.posts.expire-seconds}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> expireSeconds<span class="token punctuation">;</span>

    <span class="token comment">// Caffeine 核心接口：Cache， 子接口：LoadingCache，AsyncLoadingCache</span>

    <span class="token comment">// 帖子列表的缓存，key 为 offset:limit； value 为一页的帖子列表</span>
    <span class="token keyword">private</span> <span class="token class-name">LoadingCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> postListCache<span class="token punctuation">;</span>

    <span class="token comment">// 帖子总数的缓存，key 为 userId（永远都是 0，表示查询所有帖子）; value 为帖子的总行数</span>
    <span class="token keyword">private</span> <span class="token class-name">LoadingCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> postRowsCache<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 初始化帖子列表和总数的缓存
     */</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        postListCache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span>maxSize<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span>expireSeconds<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CacheLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// load 方法用于查不到本地缓存时，去哪儿取数据，参数是缓存的 key</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> key<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;参数错误！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> params <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>params <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> params<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;参数错误！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">int</span> limit <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// 中间可以再穿插一个二级缓存（Redis）</span>

                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;load post list from DB.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> discussPostMapper<span class="token punctuation">.</span><span class="token function">selectDiscussPosts</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> offset<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        postRowsCache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span>maxSize<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span>expireSeconds<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CacheLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Integer</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Integer</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;load post rows from DB.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> discussPostMapper<span class="token punctuation">.</span><span class="token function">selectDiscussPostRows</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> <span class="token function">findDiscussPosts</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> limit<span class="token punctuation">,</span> <span class="token keyword">int</span> orderMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 只缓存热点帖子，userId == 0 表示查询所有帖子（不为 0 表示查询某个 user 的帖子），orderMode 为 1 表示查询热点帖子</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> orderMode <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// key 的设计：offset 和 limit 能唯一确定一页帖子</span>
            <span class="token keyword">return</span> postListCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>offset <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;load post list from DB.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> discussPostMapper<span class="token punctuation">.</span><span class="token function">selectDiscussPosts</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> orderMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findDiscussPostRows</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// key 的设计：userId（永远都是 0，表示查询所有帖子）</span>
            <span class="token keyword">return</span> postRowsCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;load post rows from DB.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> discussPostMapper<span class="token punctuation">.</span><span class="token function">selectDiscussPostRows</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 其他业务方法略</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在当有大量数据时，本地缓存带来的性能提升就很大了。</p><h3 id="_7-3-配合-redis-做二级缓存" tabindex="-1"><a class="header-anchor" href="#_7-3-配合-redis-做二级缓存" aria-hidden="true">#</a> 7.3 配合 Redis 做二级缓存</h3><p>缓存的解决方案一般有三种：</p><ol><li>本地内存缓存，如 Caffeine、Ehcache； 适合单机系统，速度最快，但是容量有限，而且重启系统后缓存丢失；</li><li>集中式缓存，如 Redis、Memcached； 适合分布式系统，解决了容量、重启丢失缓存等问题，但是当访问量极大时，往往性能不是首要考虑的问题，而是带宽。现象就是 Redis 服务负载不高，但是由于机器网卡带宽跑满，导致数据读取非常慢；</li><li>第三种方案就是结合以上 2 种方案的二级缓存应运而生，以内存缓存作为一级缓存、集中式缓存作为二级缓存；</li></ol><p>二级缓存方案大致流程如下：</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210312114587.png" alt=""></p><blockquote><p>二级缓存实现</p></blockquote><p>要使用 Redis，首先第一步一定是定义好 key，二级缓存的 key 定义如下：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisKeyUtil</span> <span class="token punctuation">{</span>
    
    <span class="token comment">// 其他略</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> PREFIX_L2CACHE_POSTS <span class="token operator">=</span> <span class="token string">&quot;l2cache:posts&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> PREFIX_L2CACHE_POST_ROWS <span class="token operator">=</span> <span class="token string">&quot;l2cache:post:rows&quot;</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 二级缓存：帖子列表</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getL2CachePostsKey</span><span class="token punctuation">(</span><span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> PREFIX_L2CACHE_POSTS <span class="token operator">+</span> SPLIT <span class="token operator">+</span> offset <span class="token operator">+</span> SPLIT <span class="token operator">+</span> limit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 二级缓存：帖子总行数</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getL2CachePostRowsKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> PREFIX_L2CACHE_POST_ROWS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里把二级缓存定义统一的前缀，方便后面做清理操作。</p><p>由于我们在更新帖子分数的时候需要清除一级缓存和二级缓存，所以我把 Caffeine 封装成了一个工具类，这样在更新帖子分数时也可以调用本地缓存来进行清理操作。</p><p>其实还有一个方案是把本地缓存和 Redis 缓存的过期时间都设置成更新帖子分数的定时任务的时间间隔。这样在下一次更新帖子分数时缓存刚好也失效了，但是这样总感觉有一个约束，我的缓存为什么要依赖于定时任务的时间呢？？</p><p>我不管你什么时候执行定时任务更新帖子分数，你也别管我缓存过久过期。只要在你更新帖子分数时我清理掉缓存，<strong>保证数据库和缓存一致</strong>（非强一致） 即可。</p><p>抽出来的 CaffeineUtil：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@desc</span>: 本地缓存 CaffeineUtil
 * <span class="token keyword">@author</span>: AruNi_Lu
 * <span class="token keyword">@date</span>: 2022/10/31
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CaffeineUtil</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">CaffeineUtil</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DiscussPostMapper</span> discussPostMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${caffeine.posts.max-size}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxSize<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${caffeine.posts.expire-seconds}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> expireSeconds<span class="token punctuation">;</span>

    <span class="token comment">// Caffeine 核心接口：Cache， 子接口：LoadingCache，AsyncLoadingCache</span>

    <span class="token comment">// 帖子列表的缓存，key 为 offset:limit； value 为一页的帖子列表</span>
    <span class="token keyword">public</span> <span class="token class-name">LoadingCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> postListCache<span class="token punctuation">;</span>

    <span class="token comment">// 帖子总数的缓存，key 为 userId（永远都是 0，表示查询所有帖子）; value 为帖子的总行数</span>
    <span class="token keyword">public</span> <span class="token class-name">LoadingCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> postRowsCache<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * 初始化帖子列表和总数的缓存
     */</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        postListCache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span>maxSize<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span>expireSeconds<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CacheLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// load 方法用于查不到本地缓存时，去哪儿取数据，参数是缓存的 key</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> key<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;参数错误！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> params <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>params <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> params<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;参数错误！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">int</span> limit <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// 中间可以再穿插一个二级缓存（Redis）</span>
                        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getL2CachePostsKey</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> postList <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>postList <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> postList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;load post list from Redis.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> postList<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>


                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;load post list from DB.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        postList <span class="token operator">=</span> discussPostMapper<span class="token punctuation">.</span><span class="token function">selectDiscussPosts</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> offset<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// 从 DB 查询后初始化 Redis</span>
                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;init l2cache posts from DB.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightPushAll</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> postList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        redisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> expireSeconds<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">return</span> postList<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        postRowsCache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span>maxSize<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span>expireSeconds<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CacheLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Integer</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Integer</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token comment">// 二级缓存</span>
                        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getL2CachePostRowsKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Integer</span> rows <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>rows <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;load post rows from Redis.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> rows<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;load post rows from DB.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        rows <span class="token operator">=</span> discussPostMapper<span class="token punctuation">.</span><span class="token function">selectDiscussPostRows</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;init l2cache post rows from DB.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> rows<span class="token punctuation">,</span> expireSeconds<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">return</span> rows<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在 DiscussPostServiceImpl 中直接注入 CaffeineUtil，然后通过它调用 postListCache 和 postRowsCache即可。</p><p>在定时任务的工作类 PostScoreRefreshJob 中刷新热帖时，添加上删除缓存的代码，判断是否需要刷新热帖的方法是 execute：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">JobExecutionContext</span> jobExecutionContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JobExecutionException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getPostScoreKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取绑定 redisKey 的对象，后面直接通过这个对象来进行有关与 redisKey 相关的操作</span>
        <span class="token class-name">BoundSetOperations</span> operations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundSetOps</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>operations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[任务取消] 没有需要刷新分数的帖子&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[任务开始] 正在刷新帖子分数：&quot;</span> <span class="token operator">+</span> operations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 当 set 中有要刷新的帖子时，依次弹出进行刷新</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>operations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> operations<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 热帖刷新时，删除一级和二级缓存</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;热帖已更新，开始删除一级缓存和二级缓存！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        caffeineUtil<span class="token punctuation">.</span>postListCache<span class="token punctuation">.</span><span class="token function">cleanUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        caffeineUtil<span class="token punctuation">.</span>postRowsCache<span class="token punctuation">.</span><span class="token function">cleanUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 先获取所有关于二级缓存的键，在依次删除即可</span>
        <span class="token class-name">Set</span> keys <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token string">&quot;l2cache*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> key <span class="token operator">:</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[任务结束] 帖子分数刷新完毕！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>至此，二级缓存的功能已完成。</p><h2 id="_8-项目总结" tabindex="-1"><a class="header-anchor" href="#_8-项目总结" aria-hidden="true">#</a> 8. 项目总结</h2><p>主要的实现的功能和技术栈：</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210262337123.png" alt="image-20221026233652193"></p><p>部署上线时，重要的是性能、安全、可靠性。</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210262337052.png" alt="image-20221026233619539"></p><h2 id="_9-心得体会" tabindex="-1"><a class="header-anchor" href="#_9-心得体会" aria-hidden="true">#</a> 9. 心得体会</h2><p>总体来说仿牛客论讨这个项目还是能学到很多东西的，老师讲的也好，通俗易懂。</p><p>这是我准备用来找实习的项目，虽然像商城、论坛等已经烂大街了，但是不可否认它们确确实实是好的项目，自己能从中学到东西即可。</p><h2 id="待完善" tabindex="-1"><a class="header-anchor" href="#待完善" aria-hidden="true">#</a> 待完善</h2><ul><li>如何保证数据库与缓存的数据一致性？</li></ul></div><!--[--><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3 0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9 0l60.1 60.1c18.8 18.7 18.8 49.1 0 67.9zM284.2 99.8L21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3 0-17l-111-111c-4.8-4.7-12.4-4.7-17.1 0zM124.1 339.9c-5.5-5.5-5.5-14.3 0-19.8l154-154c5.5-5.5 14.3-5.5 19.8 0s5.5 14.3 0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8 0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg><a class="external-link meta-item-label" href="https://github.com/AruNi-01/github.AruNi.io/edit/main/posts/2022-10-31-仿牛客项目总结.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page on GitHub"><!--[--><!--]--><!----><span>Edit this page on GitHub</span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></footer><!----><!--[--><div class="pager"><a href="/posts/2022-08-21-LeetCode%20%E7%AC%AC%20307%20%E5%9C%BA%E5%91%A8%E8%B5%9B.html" class="previous">Previous<br><span>LeetCode 第 307 场周赛</span></a><a href="/posts/2022-12-1-ThreadLocal%20%E8%AF%A6%E8%A7%A3.html" class="next">Next<br><span>ThreadLocal 详解</span></a></div><!--]--><!----></main><ul class="catalog" style="top:0px;"><li class="level-2 toc-link-_1-数据库设计">1. 数据库设计</li><li class="level-3 toc-link-_1-1-用户表-user">1.1 用户表 user</li><li class="level-3 toc-link-_1-2-帖子表-discuss-post">1.2 帖子表 discuss_post</li><li class="level-3 toc-link-_1-3-评论表-comment">1.3 评论表 comment</li><li class="level-3 toc-link-_1-4-消息表-message">1.4 消息表 message</li><li class="level-3 toc-link-_1-5-登录凭证表-login-ticket">1.5 登录凭证表 login_ticket</li><li class="level-2 toc-link-_2-业务开发">2. 业务开发</li><li class="level-3 toc-link-_2-1-首页">2.1 首页</li><li class="level-3 toc-link-_2-2-注册功能">2.2 注册功能</li><li class="level-3 toc-link-_2-3-登录功能-重点">2.3 登录功能（重点）</li><li class="level-3 toc-link-_2-4-修改个人信息-重点">2.4 修改个人信息（重点）</li><li class="level-3 toc-link-_2-5-过滤敏感词">2.5 过滤敏感词</li><li class="level-3 toc-link-_2-6-统一异常处理">2.6 统一异常处理</li><li class="level-3 toc-link-_2-7-统一日志管理">2.7 统一日志管理</li><li class="level-2 toc-link-_3-redis-相关">3. Redis 相关</li><li class="level-3 toc-link-_3-1-点赞-重点">3.1 点赞（重点）</li><li class="level-3 toc-link-_3-2-关注-重点">3.2 关注（重点）</li><li class="level-3 toc-link-_3-3-页面优化">3.3 页面优化</li><li class="level-3 toc-link-_3-4-redis-高级数据类型">3.4 Redis 高级数据类型</li><li class="level-2 toc-link-_4-kafka-相关">4. Kafka 相关</li><li class="level-3 toc-link-_4-1-什么是-kafka">4.1 什么是 Kafka</li><li class="level-3 toc-link-_4-2-发送系统通知">4.2 发送系统通知</li><li class="level-2 toc-link-_5-elasticsearch-相关">5. ElasticSearch 相关</li><li class="level-3 toc-link-_5-1-为什么要用-es">5.1 为什么要用 ES</li><li class="level-3 toc-link-_5-2-什么是-es">5.2 什么是 ES</li><li class="level-3 toc-link-_5-3-搜索功能">5.3 搜索功能</li><li class="level-2 toc-link-_6-定时任务">6. 定时任务</li><li class="level-3 toc-link-_6-1-认识-quartz">6.1 认识 Quartz</li><li class="level-3 toc-link-_6-2-热榜帖子实现">6.2 热榜帖子实现</li><li class="level-2 toc-link-_7-二级缓存优化性能">7. 二级缓存优化性能</li><li class="level-3 toc-link-_7-1-认识-caffeine">7.1 认识 Caffeine</li><li class="level-3 toc-link-_7-2-使用-caffeine">7.2 使用 Caffeine</li><li class="level-3 toc-link-_7-3-配合-redis-做二级缓存">7.3 配合 Redis 做二级缓存</li><li class="level-2 toc-link-_8-项目总结">8. 项目总结</li><li class="level-2 toc-link-_9-心得体会">9. 心得体会</li><li class="level-2 toc-link-待完善">待完善</li></ul></div><!--]--></div><div class="search-page" role="search"><span class="search-close"><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 448 512" width="28" height="28" fill="currentColor"><path d="M224 416c-8.188 0-16.38-3.125-22.62-9.375l-192-192c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L224 338.8l169.4-169.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-192 192C240.4 412.9 232.2 416 224 416z"></path></svg></span><div class="gungnir-search-box"><input placeholder="$ grep title | tag ..." autocomplete="off" spellcheck="false" value><!----></div></div><div class="menu-btn-container"><div class="menu-btn-wrapper"><div class="menu-btn"><div style="" class="menu-btn-icon"><span></span><span></span><span></span></div><div style="display:none;" class="menu-text">0</div><svg class="menu-progress"><circle class="menu-border" cx="50%" cy="50%" r="48%" style="stroke-dasharray:0% 314.15926%;"></circle></svg></div><div class="menu-btn-child-wrapper"><div title="toggle color mode" class="menu-btn-child"><svg class="ov-icon" style="font-size:1.2em;display:none;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M256 160c-52.9 0-96 43.1-96 96s43.1 96 96 96 96-43.1 96-96-43.1-96-96-96zm246.4 80.5l-94.7-47.3 33.5-100.4c4.5-13.6-8.4-26.5-21.9-21.9l-100.4 33.5-47.4-94.8c-6.4-12.8-24.6-12.8-31 0l-47.3 94.7L92.7 70.8c-13.6-4.5-26.5 8.4-21.9 21.9l33.5 100.4-94.7 47.4c-12.8 6.4-12.8 24.6 0 31l94.7 47.3-33.5 100.5c-4.5 13.6 8.4 26.5 21.9 21.9l100.4-33.5 47.3 94.7c6.4 12.8 24.6 12.8 31 0l47.3-94.7 100.4 33.5c13.6 4.5 26.5-8.4 21.9-21.9l-33.5-100.4 94.7-47.3c13-6.5 13-24.7.2-31.1zm-155.9 106c-49.9 49.9-131.1 49.9-181 0-49.9-49.9-49.9-131.1 0-181 49.9-49.9 131.1-49.9 181 0 49.9 49.9 49.9 131.1 0 181z"/></svg><svg class="ov-icon" style="font-size:1.2em;display:none;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M283.211 512c78.962 0 151.079-35.925 198.857-94.792 7.068-8.708-.639-21.43-11.562-19.35-124.203 23.654-238.262-71.576-238.262-196.954 0-72.222 38.662-138.635 101.498-174.394 9.686-5.512 7.25-20.197-3.756-22.23A258.156 258.156 0 00283.211 0c-141.309 0-256 114.511-256 256 0 141.309 114.511 256 256 256z"/></svg><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M224 96l16-32 32-16-32-16-16-32-16 32-32 16 32 16 16 32zM80 160l26.66-53.33L160 80l-53.34-26.67L80 0 53.34 53.33 0 80l53.34 26.67L80 160zm352 128l-26.66 53.33L352 368l53.34 26.67L432 448l26.66-53.33L512 368l-53.34-26.67L432 288zm70.62-193.77L417.77 9.38C411.53 3.12 403.34 0 395.15 0c-8.19 0-16.38 3.12-22.63 9.38L9.38 372.52c-12.5 12.5-12.5 32.76 0 45.25l84.85 84.85c6.25 6.25 14.44 9.37 22.62 9.37 8.19 0 16.38-3.12 22.63-9.37l363.14-363.15c12.5-12.48 12.5-32.75 0-45.24zM359.45 203.46l-50.91-50.91 86.6-86.6 50.91 50.91-86.6 86.6z"/></svg></div><div class="menu-btn-child"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-75.52 -43.52 599.04 599.04" fill="currentColor"><path d="M207.029 381.476L12.686 187.132c-9.373-9.373-9.373-24.569 0-33.941l22.667-22.667c9.357-9.357 24.522-9.375 33.901-.04L224 284.505l154.745-154.021c9.379-9.335 24.544-9.317 33.901.04l22.667 22.667c9.373 9.373 9.373 24.569 0 33.941L240.971 381.476c-9.373 9.372-24.569 9.372-33.942 0z"/></svg></div><div class="menu-btn-child"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-75.52 -43.52 599.04 599.04" fill="currentColor"><path d="M240.971 130.524l194.343 194.343c9.373 9.373 9.373 24.569 0 33.941l-22.667 22.667c-9.357 9.357-24.522 9.375-33.901.04L224 227.495 69.255 381.516c-9.379 9.335-24.544 9.317-33.901-.04l-22.667-22.667c-9.373-9.373-9.373-24.569 0-33.941L207.03 130.525c9.372-9.373 24.568-9.373 33.941-.001z"/></svg></div><div class="menu-btn-child menu-toc-btn"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M48 48a48 48 0 1048 48 48 48 0 00-48-48zm0 160a48 48 0 1048 48 48 48 0 00-48-48zm0 160a48 48 0 1048 48 48 48 0 00-48-48zm448 16H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16z"/></svg></div><div class="toggle-sidebar-button menu-btn-child menu-btn-sidebar" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-1.6 -1.6 19.2 19.2" fill="currentColor"><path d="M14 2a1 1 0 011 1v10a1 1 0 01-1 1H2a1 1 0 01-1-1V3a1 1 0 011-1h12zM2 1a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V3a2 2 0 00-2-2H2z"/><path d="M3 4a1 1 0 011-1h2a1 1 0 011 1v8a1 1 0 01-1 1H4a1 1 0 01-1-1V4z"/></svg></div></div></div></div><footer class="footer"><span>
      <a href="https://v2.vuepress.vuejs.org/" target="_blank">VuePress</a> 🤍
      <a href="https://github.com/Renovamen/vuepress-theme-gungnir" target="_blank">Gungnir</a>
      <br>
      Copyright &copy; 2020-2022 <a href="https://github.com/AruNi-01" target="_blank">AruNi_Lu</a>
    </span></footer></div><!----><!--]--></div>
    <script type="module" src="/assets/app.75c9db72.js" defer></script>
  </body>
</html>
